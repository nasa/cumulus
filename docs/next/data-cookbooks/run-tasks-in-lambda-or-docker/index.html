<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Run Step Function Tasks in Lambda or Docker · Cumulus Documentation</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Running Step Function Tasks in AWS Lambda or Docker"/><meta name="docsearch:version" content="next"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Run Step Function Tasks in Lambda or Docker · Cumulus Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://nasa.github.io/cumulus/"/><meta property="og:description" content="# Running Step Function Tasks in AWS Lambda or Docker"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/cumulus/undefined"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/cumulus/js/scrollSpy.js"></script><link rel="stylesheet" href="/cumulus/css/main.css"/><script src="/cumulus/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cumulus/"><h2 class="headerTitle">Cumulus Documentation</h2></a><a href="/cumulus/versions"><h3>next</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://nasa.github.io/cumulus-api" target="_self">API Docs</a></li><li class=""><a href="/cumulus/docs/next/cumulus-docs-readme" target="_self">Developer Docs</a></li><li class="siteNavGroupActive"><a href="/cumulus/docs/next/data-cookbooks/about-cookbooks" target="_self">Data-Cookbooks</a></li><li class=""><a href="/cumulus/docs/next/operator-docs/about-operator-docs" target="_self">Operator Docs</a></li><li class=""><a href="/cumulus/docs/next/team" target="_self">Team</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Cookbooks</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">About Cookbooks<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/about-cookbooks">About Cookbooks</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/setup">Data Cookbooks Setup</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Cookbooks<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/hello-world">HelloWorld Workflow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/sns">SNS Notification in Workflows</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/sips-workflow">Science Investigator-led Processing Systems (SIPS)</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/cnm-workflow">CNM Workflow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/error-handling">Error Handling in Workflows</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/choice-states">Choice States</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/cloudwatch-retention">Cloudwatch Retention</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/browse-generation">Ingest Browse Generation</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/tracking-files">Tracking Ancillary Files</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/run-tasks-in-lambda-or-docker">Run Step Function Tasks in Lambda or Docker</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/next/data-cookbooks/throttling-queued-executions">Throttling queued executions</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="running-step-function-tasks-in-aws-lambda-or-docker"></a><a href="#running-step-function-tasks-in-aws-lambda-or-docker" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running Step Function Tasks in AWS Lambda or Docker</h1>
<h2><a class="anchor" aria-hidden="true" id="overview"></a><a href="#overview" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Overview</h2>
<p><a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-tasks.html">AWS Step Function Tasks</a> can run tasks on <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> or on <a href="https://aws.amazon.com/ecs/">AWS Elastic Container Service (ECS)</a> as a Docker container.</p>
<p>Lambda provides serverless architecture, providing the best option for minimizing cost and server management. ECS provides the fullest extent of AWS EC2 resources via the flexibility to execute arbitrary code on any AWS EC2 instance type.</p>
<h2><a class="anchor" aria-hidden="true" id="when-to-use-lambda"></a><a href="#when-to-use-lambda" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>When to use Lambda</h2>
<p>You should use AWS Lambda whenever all of the following are true:</p>
<ul>
<li>The task runs on one of the supported <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html">Lambda Runtimes</a>. At time of this writing, supported runtimes include versions of python, Java, Ruby, node.js, Go and .NET.</li>
<li>The lambda package is less than 50 MB in size, zipped.</li>
<li>The task consumes less than each of the following resources:
<ul>
<li>3008 MB memory allocation</li>
<li>512 MB disk storage (must be written to <code>/tmp</code>)</li>
<li>15 minutes of execution time</li>
</ul></li>
</ul>
<p>See <a href="https://docs.aws.amazon.com/lambda/latest/dg/limits.html">this page</a> for a complete and up-to-date list of AWS Lambda limits.</p>
<p>If your task requires more than any of these resources or an unsupported runtime, creating a Docker image which can be run on ECS is the way to go. Cumulus supports running any lambda package (and its configured layers) as a Docker container with <a href="https://github.com/nasa/cumulus-ecs-task"><code>cumulus-ecs-task</code></a>.</p>
<h2><a class="anchor" aria-hidden="true" id="step-function-activities-and-cumulus-ecs-task"></a><a href="#step-function-activities-and-cumulus-ecs-task" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step Function Activities and <code>cumulus-ecs-task</code></h2>
<p><a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-activities.html">Step Function Activities</a> enable a state machine task to &quot;publish&quot; an activity task which can be picked up by any activity worker. Activity workers can run pretty much anywhere, but Cumulus workflows support the <a href="https://github.com/nasa/cumulus-ecs-task"><code>cumulus-ecs-task</code></a> activity worker. The <code>cumulus-ecs-task</code> worker runs as a Docker container on the Cumulus ECS cluster.</p>
<p>The <code>cumulus-ecs-task</code> container takes an AWS Lambda Amazon Resource Name (ARN) as an argument (see <code>--lambdaArn</code> in the example below). This ARN argument is defined at deployment time. The <code>cumulus-ecs-task</code> worker polls for new Step Function Activity Tasks. When a Step Function executes, the worker (container) picks up the activity task and runs the code contained in the lambda package defined on deployment.</p>
<h2><a class="anchor" aria-hidden="true" id="example-replacing-aws-lambda-with-a-docker-container-run-on-ecs"></a><a href="#example-replacing-aws-lambda-with-a-docker-container-run-on-ecs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example: Replacing AWS Lambda with a Docker container run on ECS</h2>
<p>This example will use an already-defined workflow from the <code>cumulus</code> module that includes the <a href="https://github.com/nasa/cumulus/blob/master/tf-modules/ingest/queue-granules-task.tf"><code>QueueGranules</code> task</a> in its configuration.</p>
<p>The following example is an excerpt from the <a href="https://github.com/nasa/cumulus/blob/master/example/cumulus-tf/discover_granules_workflow.tf">Discover Granules workflow</a> containing the step definition for the <code>Queue Granules</code> step:</p>
<pre><code class="hljs css language-json">  "QueueGranules": {
      "Parameters": {
        "cma": {
          "event.$": "$",
          "ReplaceConfig": {
            "FullMessage": true
          },
          "task_config": {
            "provider": "{$.meta.provider}",
            "internalBucket": "{$.meta.buckets.internal.name}",
            "stackName": "{$.meta.stack}",
            "granuleIngestWorkflow": "${module.ingest_granule_workflow.name}",
            "queueUrl": "{$.meta.queues.startSF}"
          }
        }
      },
      "Type": "Task",
      "Resource": "${module.cumulus.queue_granules_task.task_arn}",
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Catch": [
        {
          "ErrorEquals": [
            "States.ALL"
          ],
          "ResultPath": "$.exception",
          "Next": "WorkflowFailed"
        }
      ],
      "Next": "CheckStatus"
    },
</code></pre>
<p>Given it has been discovered this task can no longer run in AWS Lambda, you can instead run it on the Cumulus ECS cluster by adding the following resources to your terraform deployment (by either adding a new <code>.tf</code> file or updating an existing one):</p>
<ul>
<li>A <code>aws_sfn_activity</code> resource:</li>
</ul>
<pre><code class="hljs css language-hcl"><span class="hljs-attribute">resource</span> <span class="hljs-string">"aws_sfn_activity"</span> <span class="hljs-string">"queue_granules"</span> {
  <span class="hljs-attribute">name</span> = <span class="hljs-string">"<span class="hljs-variable">${var.prefix}</span>-QueueGranules"</span>
  tags = local.default_tags
}
</code></pre>
<ul>
<li>An instance of the <code>cumulus_ecs_service</code> module (found on the <a href="https://github.com/nasa/cumulus/releases">Cumulus releases page</a> configured to provide the <code>QueueGranules</code> task:</li>
</ul>
<pre><code class="hljs css language-hcl">
module <span class="hljs-string">"queue_granules_service"</span> {
  <span class="hljs-attr">source</span> = <span class="hljs-string">"https://github.com/nasa/cumulus/releases/download/{version}/terraform-aws-cumulus-ecs-service.zip"</span>

  <span class="hljs-attr">prefix</span> = var.prefix
  <span class="hljs-attr">name</span>   = <span class="hljs-string">"QueueGranules"</span>
  <span class="hljs-attr">tags</span>   = local.default_tags

  <span class="hljs-attr">cluster_arn</span>                           = module.cumulus.ecs_cluster_arn
  <span class="hljs-attr">desired_count</span>                         = <span class="hljs-number">1</span>
  <span class="hljs-attr">image</span>                                 = <span class="hljs-string">"cumuluss/cumulus-ecs-task:1.3.0"</span>
  <span class="hljs-attr">log2elasticsearch_lambda_function_arn</span> = module.cumulus.log2elasticsearch_lambda_function_arn

  <span class="hljs-attr">cpu</span>                = <span class="hljs-number">400</span>
  <span class="hljs-attr">memory_reservation</span> = <span class="hljs-number">700</span>

  <span class="hljs-attr">environment</span> = {
    <span class="hljs-attr">AWS_DEFAULT_REGION</span> = data.aws_region.current.name
  }
  <span class="hljs-attr">command</span> = [
    <span class="hljs-string">"cumulus-ecs-task"</span>,
    <span class="hljs-string">"--activityArn"</span>,
    aws_sfn_activity.queue_granules.id,
    <span class="hljs-string">"--lambdaArn"</span>,
    module.cumulus.queue_granules_task.task_arn
  ]
  <span class="hljs-attr">alarms</span> = {
    <span class="hljs-attr">TaskCountHigh</span> = {
      <span class="hljs-attr">comparison_operator</span> = <span class="hljs-string">"GreaterThanThreshold"</span>
      <span class="hljs-attr">evaluation_periods</span>  = <span class="hljs-number">1</span>
      <span class="hljs-attr">metric_name</span>         = <span class="hljs-string">"MemoryUtilization"</span>
      <span class="hljs-attr">statistic</span>           = <span class="hljs-string">"SampleCount"</span>
      <span class="hljs-attr">threshold</span>           = <span class="hljs-number">1</span>
    }
  }
}
</code></pre>
<ul>
<li>An updated <a href="https://github.com/nasa/cumulus/blob/master/example/cumulus-tf/discover_granules_workflow.tf">Discover Granules workflow</a> to utilize the new resource (the resource key in the <code>QueueGranules</code> step has been updated to:</li>
</ul>
<p><code>&quot;Resource&quot;: &quot;${aws_sfn_activity.queue_granules.id}&quot;</code>)`</p>
<pre><code class="hljs css language-hcl">module <span class="hljs-string">"cookbook_discover_granules_workflow"</span> {
  source = <span class="hljs-string">"https://github.com/jkovarik/cumulus/releases/download/v1.27.0/terraform-aws-cumulus-workflow.zip"</span>

 <span class="hljs-built_in"> prefix </span>                               = var.prefix
  name                                  = <span class="hljs-string">"CookbookDiscoverGranules"</span>
  workflow_config                       = module.cumulus.workflow_config
  system_bucket                         = var.system_bucket
  tags                                  = local.default_tags

  state_machine_definition = &lt;&lt;JSON
{
  <span class="hljs-string">"Comment"</span>: <span class="hljs-string">"Discovers new Granules from a given provider"</span>,
  <span class="hljs-string">"StartAt"</span>: <span class="hljs-string">"DiscoverGranules"</span>,
  <span class="hljs-string">"TimeoutSeconds"</span>: 18000,
  <span class="hljs-string">"States"</span>: {
    <span class="hljs-string">"DiscoverGranules"</span>: {
      <span class="hljs-string">"Parameters"</span>: {
        <span class="hljs-string">"cma"</span>: {
          <span class="hljs-string">"event.$"</span>: <span class="hljs-string">"$"</span>,
          <span class="hljs-string">"ReplaceConfig"</span>: {
            <span class="hljs-string">"FullMessage"</span>: <span class="hljs-literal">true</span>
          },
          <span class="hljs-string">"task_config"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"{$.meta.provider}"</span>,
            <span class="hljs-string">"collection"</span>: <span class="hljs-string">"{$.meta.collection}"</span>,
            <span class="hljs-string">"buckets"</span>: <span class="hljs-string">"{$.meta.buckets}"</span>,
            <span class="hljs-string">"stack"</span>: <span class="hljs-string">"{$.meta.stack}"</span>
          }
        }
      },
      <span class="hljs-string">"Type"</span>: <span class="hljs-string">"Task"</span>,
      <span class="hljs-string">"Resource"</span>: <span class="hljs-string">"<span class="hljs-variable">${module.cumulus.discover_granules_task.task_arn}</span>"</span>,
      <span class="hljs-string">"Retry"</span>: [
        {
          <span class="hljs-string">"ErrorEquals"</span>: [
            <span class="hljs-string">"Lambda.ServiceException"</span>,
            <span class="hljs-string">"Lambda.AWSLambdaException"</span>,
            <span class="hljs-string">"Lambda.SdkClientException"</span>
          ],
          <span class="hljs-string">"IntervalSeconds"</span>: 2,
          <span class="hljs-string">"MaxAttempts"</span>: 6,
          <span class="hljs-string">"BackoffRate"</span>: 2
        }
      ],
      <span class="hljs-string">"Catch"</span>: [
        {
          <span class="hljs-string">"ErrorEquals"</span>: [
            <span class="hljs-string">"States.ALL"</span>
          ],
          <span class="hljs-string">"ResultPath"</span>: <span class="hljs-string">"$.exception"</span>,
          <span class="hljs-string">"Next"</span>: <span class="hljs-string">"WorkflowFailed"</span>
        }
      ],
      <span class="hljs-string">"Next"</span>: <span class="hljs-string">"QueueGranules"</span>
    },
    <span class="hljs-string">"QueueGranules"</span>: {
      <span class="hljs-string">"Parameters"</span>: {
        <span class="hljs-string">"cma"</span>: {
          <span class="hljs-string">"event.$"</span>: <span class="hljs-string">"$"</span>,
          <span class="hljs-string">"ReplaceConfig"</span>: {
            <span class="hljs-string">"FullMessage"</span>: <span class="hljs-literal">true</span>
          },
          <span class="hljs-string">"task_config"</span>: {
            <span class="hljs-string">"queueUrl"</span>: <span class="hljs-string">"{$.meta.queues.startSF}"</span>,
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"{$.meta.provider}"</span>,
            <span class="hljs-string">"internalBucket"</span>: <span class="hljs-string">"{$.meta.buckets.internal.name}"</span>,
            <span class="hljs-string">"stackName"</span>: <span class="hljs-string">"{$.meta.stack}"</span>,
            <span class="hljs-string">"granuleIngestWorkflow"</span>: <span class="hljs-string">"<span class="hljs-variable">${var.prefix}</span>-IngestGranule"</span>
          }
        }
      },
      <span class="hljs-string">"Type"</span>: <span class="hljs-string">"Task"</span>,
      <span class="hljs-string">"Resource"</span>: <span class="hljs-string">"<span class="hljs-variable">${aws_sfn_activity.queue_granules.id}</span>"</span>,
      <span class="hljs-string">"Retry"</span>: [
        {
          <span class="hljs-string">"ErrorEquals"</span>: [
            <span class="hljs-string">"Lambda.ServiceException"</span>,
            <span class="hljs-string">"Lambda.AWSLambdaException"</span>,
            <span class="hljs-string">"Lambda.SdkClientException"</span>
          ],
          <span class="hljs-string">"IntervalSeconds"</span>: 2,
          <span class="hljs-string">"MaxAttempts"</span>: 6,
          <span class="hljs-string">"BackoffRate"</span>: 2
        }
      ],
      <span class="hljs-string">"Catch"</span>: [
        {
          <span class="hljs-string">"ErrorEquals"</span>: [
            <span class="hljs-string">"States.ALL"</span>
          ],
          <span class="hljs-string">"ResultPath"</span>: <span class="hljs-string">"$.exception"</span>,
          <span class="hljs-string">"Next"</span>: <span class="hljs-string">"WorkflowFailed"</span>
        }
      ],
      <span class="hljs-string">"End"</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-string">"WorkflowFailed"</span>: {
      <span class="hljs-string">"Type"</span>: <span class="hljs-string">"Fail"</span>,
      <span class="hljs-string">"Cause"</span>: <span class="hljs-string">"Workflow failed"</span>
    }
  }
}
JSON
}
</code></pre>
<p>If you then run this workflow in place of the <code>DiscoverGranules</code> workflow, the <code>QueueGranules</code> step would run as an ECS task instead of a lambda.</p>
<h2><a class="anchor" aria-hidden="true" id="final-note"></a><a href="#final-note" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Final note</h2>
<p>Step Function Activities and AWS Lambda are not the only ways to run tasks in an AWS Step Function. Learn more about other service integrations, including direct ECS integration via the <a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-connectors.html">AWS Service Integrations</a> page.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/cumulus/docs/next/data-cookbooks/tracking-files"><span class="arrow-prev">← </span><span>Tracking Ancillary Files</span></a><a class="docs-next button" href="/cumulus/docs/next/data-cookbooks/throttling-queued-executions"><span>Throttling queued executions</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#overview">Overview</a></li><li><a href="#when-to-use-lambda">When to use Lambda</a></li><li><a href="#step-function-activities-and-cumulus-ecs-task">Step Function Activities and <code>cumulus-ecs-task</code></a></li><li><a href="#example-replacing-aws-lambda-with-a-docker-container-run-on-ecs">Example: Replacing AWS Lambda with a Docker container run on ECS</a></li><li><a href="#final-note">Final note</a></li></ul></nav></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f7e0be879553661f9043322d119069c8',
                indexName: 'nasa_cumulus',
                inputSelector: '#search_input_react'
              });
            </script></body></html>