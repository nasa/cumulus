"use strict";(self.webpackChunk_cumulus_website=self.webpackChunk_cumulus_website||[]).push([[61705],{15680:(e,a,n)=>{n.d(a,{xA:()=>d,yg:()=>c});var t=n(296540);function i(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function r(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter(function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable})),n.push.apply(n,t)}return n}function o(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?r(Object(n),!0).forEach(function(a){i(e,a,n[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach(function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))})}return e}function l(e,a){if(null==e)return{};var n,t,i=function(e,a){if(null==e)return{};var n,t,i={},r=Object.keys(e);for(t=0;t<r.length;t++)n=r[t],a.indexOf(n)>=0||(i[n]=e[n]);return i}(e,a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(t=0;t<r.length;t++)n=r[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var u=t.createContext({}),s=function(e){var a=t.useContext(u),n=a;return e&&(n="function"==typeof e?e(a):o(o({},a),e)),n},d=function(e){var a=s(e.components);return t.createElement(u.Provider,{value:a},e.children)},p="mdxType",g={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},m=t.forwardRef(function(e,a){var n=e.components,i=e.mdxType,r=e.originalType,u=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),p=s(n),m=i,c=p["".concat(u,".").concat(m)]||p[m]||g[m]||r;return n?t.createElement(c,o(o({ref:a},d),{},{components:n})):t.createElement(c,o({ref:a},d))});function c(e,a){var n=arguments,i=a&&a.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=m;var l={};for(var u in a)hasOwnProperty.call(a,u)&&(l[u]=a[u]);l.originalType=e,l[p]="string"==typeof e?e:i,o[1]=l;for(var s=2;s<r;s++)o[s]=n[s];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}m.displayName="MDXCreateElement"},56361:(e,a,n)=>{n.d(a,{A:()=>t});const t=n.p+"assets/images/granule_uniqification_updates-a96807d448f0ff540ccf5f2497803d53.png"},769020:(e,a,n)=>{n.d(a,{A:()=>t});const t=n.p+"assets/images/stepfunctions_graph-d2c558e6cba2f82960a345bc59ca5ff3.png"},899987:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>d,contentTitle:()=>u,default:()=>c,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var t=n(58168),i=n(198587),r=(n(296540),n(15680)),o=["components"],l={id:"granule_uniquification",title:"Granule Uniquification Feature",hide_title:!1},u=void 0,s={unversionedId:"features/granule_uniquification",id:"features/granule_uniquification",title:"Granule Uniquification Feature",description:"Overview",source:"@site/../docs/features/granule_uniquification.md",sourceDirName:"features",slug:"/features/granule_uniquification",permalink:"/cumulus/docs/next/features/granule_uniquification",draft:!1,tags:[],version:"current",lastUpdatedBy:"Nate Pauzenga",lastUpdatedAt:1757096240,formattedLastUpdatedAt:"Sep 5, 2025",frontMatter:{id:"granule_uniquification",title:"Granule Uniquification Feature",hide_title:!1},sidebar:"docs",previous:{title:"How to replay SQS messages archived in S3",permalink:"/cumulus/docs/next/features/replay-archived-sqs-messages"},next:{title:"Cumulus Change Granule Collections",permalink:"/cumulus/docs/next/features/change_granule_collection"}},d={},p=[{value:"<strong>Overview</strong>",id:"overview",level:2},{value:"Technical Approach",id:"technical-approach",level:2},{value:"<em>Adding &#39;uniquification&#39; to Ingest Workflows</em>",id:"adding-uniquification-to-ingest-workflows",level:3},{value:"<strong>Uniquification Methodology</strong>",id:"uniquification-methodology",level:3},{value:"External Impacts",id:"external-impacts",level:3},{value:"Migration From Prior Versions",id:"migration-from-prior-versions",level:2},{value:"Existing Workflow Updates",id:"existing-workflow-updates",level:3},{value:"Core Changes",id:"core-changes",level:2},{value:"Schema Changes",id:"schema-changes",level:3},{value:"Updated <code>MoveGranules</code> &#39;duplicate&#39; handling behavior",id:"updated-movegranules-duplicate-handling-behavior",level:3},{value:"Updated Workflow Task Component Modifications",id:"updated-workflow-task-component-modifications",level:3},{value:"Added",id:"added",level:4},{value:"<code>AddUniqueGranuleId</code>",id:"adduniquegranuleid",level:5},{value:"Updated",id:"updated",level:4},{value:"<code>LzardsBackup</code>",id:"lzardsbackup",level:5},{value:"<code>ParsePdr</code>",id:"parsepdr",level:5},{value:"<code>QueueGranules</code>",id:"queuegranules",level:5},{value:"<code>UpdateGranulesCmrMetadataFileLinks</code>",id:"updategranulescmrmetadatafilelinks",level:5},{value:"<code>FilesToGranules</code>",id:"filestogranules",level:5},{value:"Updated Cumulus Framework Behaviors",id:"updated-cumulus-framework-behaviors",level:3},{value:"Workflow Feature Use",id:"workflow-feature-use",level:2},{value:"Collection Configuration",id:"collection-configuration",level:3},{value:"Collection Path Considerations",id:"collection-path-considerations",level:4},{value:"Workflow Configuration",id:"workflow-configuration",level:3},{value:"Workflow Examples",id:"workflow-examples",level:3},{value:"SIPS/PDR Based Workflow",id:"sipspdr-based-workflow",level:4},{value:"CNM/Kinesis Style Ingest Workflow",id:"cnmkinesis-style-ingest-workflow",level:4}],g={toc:p},m="wrapper";function c(e){var a=e.components,l=(0,i.A)(e,o);return(0,r.yg)(m,(0,t.A)({},g,l,{components:a,mdxType:"MDXLayout"}),(0,r.yg)("h2",{id:"overview"},(0,r.yg)("strong",{parentName:"h2"},"Overview")),(0,r.yg)("p",null,"The Granule Uniquification feature in Cumulus allows for the ingestion and management of multiple granules that share the same ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," but belong to different collections. This is achieved by creating a unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," for each granule and storing the original, non-unique identifier in a new field called ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId"),"."),(0,r.yg)("p",null,"This feature is critical for systems migrating from ECS and other workflows where ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," may not be globally unique.    Existing workflows that have no need for this feature should be compatible with no changes, however the end result will be the ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," will be set to the same value if producerGranuleId is not specified."),(0,r.yg)("p",null,"This feature was added in Cumulus version 21, this document provides an overview of the feature and high level changes associated with the feature from previous versions."),(0,r.yg)("h2",{id:"technical-approach"},"Technical Approach"),(0,r.yg)("p",null,"The changes included with this feature make updates to the Cumulus database schema, granule read/write/reporting components and workflow task components."),(0,r.yg)("p",null,"The intent is to modify the Cumulus database and framework to handle tracking both a unique identifier ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," and provide a granule object field ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," that tracks an identifier from the data producer/provider that ",(0,r.yg)("em",{parentName:"p"},"may not")," be unique."),(0,r.yg)("p",null,"In concert with those updates, Cumulus task components that generate granule objects have been updated to optionally be configured to 'uniquify' granule objects by generating a unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," and storing the original ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," value in the ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," field."),(0,r.yg)("h3",{id:"adding-uniquification-to-ingest-workflows"},(0,r.yg)("em",{parentName:"h3"},"Adding 'uniquification' to Ingest Workflows")),(0,r.yg)("p",null,"The process of updating or creating an ingest workflow that makes use of this feature should follow the following high-level guidelines:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"If providers/pre-ingest processing provides ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," as part of the granule object and pre-uniquifies the graunleId, Core task components will 'do the right thing' out of the box.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Ingest workflows that have incoming granules that have only granuleId populated will need to make use of the updated Cumulus workflow task components ",(0,r.yg)("em",{parentName:"p"},"or")," make updates to other in-use functions to make the granuleId unique  as appropriate.  For details on this, please see the following:"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("a",{parentName:"p",href:"/cumulus/docs/next/features/granule-id-hashing-approach"},"hashing approach document")," for details on the approach Cumulus components that create a ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," are using.  Please also review the added task component")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/tasks/add-unique-granule-id/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"AddUniqueGranuleId"))," that can be utilized in workflows to update a granule with a unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId"),", saving the 'original' as ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId"),".")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("a",{parentName:"p",href:"#updated-workflow-task-component-modifications"},"Updated Workflow Task Component Modifications"))))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Workflows that ",(0,r.yg)("em",{parentName:"p"},"start")," with a Cumulus message (",(0,r.yg)("em",{parentName:"p"},"not")," a CNM message or other format) with a payload containing granules but intend to change the ID as part of the workflow will need to reconfigure Cumulus to not report the initial granules prior to workflow steps that update the granule to have a unique Id and ",(0,r.yg)("em",{parentName:"p"},"optionally")," update the workflow to report them as running following that uniquification using ",(0,r.yg)("inlineCode",{parentName:"p"},"SfSqsReportTask"),".  See ",(0,r.yg)("a",{parentName:"p",href:"/cumulus/docs/next/features/record_write_options"},"Record Write Options feature doc")," for more information."))),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},(0,r.yg)("em",{parentName:"strong"},"Important")),": User task components, particularly any that re-implement core reference tasks, must be evaluated carefully to ensure consistent behavior in instances where the ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," has been modified."),(0,r.yg)("p",null,"The following diagram shows expected flow and potential modification considerations for a typical ingest flow, with orange being components that may need modification/update to make use of this feature, and green representing updated Core task components:"),(0,r.yg)("hr",null),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Workflow Impacts",src:n(56361).A,width:"1579",height:"1807"})),(0,r.yg)("hr",null),(0,r.yg)("h3",{id:"uniquification-methodology"},(0,r.yg)("strong",{parentName:"h3"},"Uniquification Methodology")),(0,r.yg)("p",null,"Optimally, adding a ",(0,r.yg)("inlineCode",{parentName:"p"},"uniqueGranuleId")," and populating a relevant ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," in incoming granules should be done prior to ingest into Cumulus.  Cumulus maintained workflow tasks have been updated to handle incoming messages with ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," appropriately."),(0,r.yg)("p",null,"If that's not possible due to filename based discovery ingest, or provider process restrictions, the updated task components allow an in-workflow approach to making granuleIds unique."),(0,r.yg)("p",null,"When a workflow is configured to utilize any of the modified tasks that generate a unique ID, Cumulus workflow tasks use a hashing algorithm to generate a unique suffix that is appended to the original ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId"),". This process is handled by the ",(0,r.yg)("inlineCode",{parentName:"p"},"add-unique-granule-id")," task, is integrated into some tasks (e.g. ",(0,r.yg)("inlineCode",{parentName:"p"},"parse_pdr"),"), or relevant user tasks can be updated  as well."),(0,r.yg)("p",null,"The recommended algorithm generates an MD5 hash of the granule's ",(0,r.yg)("inlineCode",{parentName:"p"},"collectionId")," (and optionally a timestamp) and appends a truncated version of this hash to the ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," to create the new unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId"),"."),(0,r.yg)("p",null,"The process Cumulus Core uses to generate a unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," can be found in the ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/packages/ingest/src/granule.ts"},(0,r.yg)("inlineCode",{parentName:"a"},"generateUniqueGranuleId")," function"),"."),(0,r.yg)("p",null,"For more details on the algorithm and for implementations in other languages, see the ",(0,r.yg)("a",{parentName:"p",href:"/cumulus/docs/next/features/granule-id-hashing-approach"},"Hashing approach document")),(0,r.yg)("p",null,"There is no requirement to utilize Core's algorithm, as the workflow framework imposes no constraints outside of ensuring ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," is populated by a default, ",(0,r.yg)("em",{parentName:"p"},"however")," if customization is desired, care should be taken to ensure that unique identification schemes are chosen such that unexpected collisions between granules do not occur system-wide."),(0,r.yg)("p",null,"To make the process easier, Cumulus Core also provides a Task Component that will uniquely identify each Granule in a payload and return a modified Granule object containing a unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," and a ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," containing the original ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," - ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/tasks/add-unique-granule-id/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"AddUniqueGranuleId"))),(0,r.yg)("hr",null),(0,r.yg)("h3",{id:"external-impacts"},"External Impacts"),(0,r.yg)("p",null,"Deploying a version of Cumulus with this feature enabled will result in the following impacts to downstream ecosystem as of when this document was last updated:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"CMR - Exported CMR metadata will now have UMMG/XML appropriate metadata populating the ",(0,r.yg)("inlineCode",{parentName:"li"},"ProducerGranuleId")," in workflows that make use of the ",(0,r.yg)("inlineCode",{parentName:"li"},"Update Granules CMR Metadata File Links")," task.   For more information/specifics see the ",(0,r.yg)("a",{parentName:"li",href:"https://github.com/nasa/cumulus/blob/master/tasks/update-granules-cmr-metadata-file-links/README.md"},"task README")),(0,r.yg)("li",{parentName:"ul"},"Metrics - Granule objects newly ingested/updated will have the ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," field populated"),(0,r.yg)("li",{parentName:"ul"},"Lzards - Granules ingested using the updated task component will now have ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," field populated as part of the LZARDS metadata."),(0,r.yg)("li",{parentName:"ul"},"Orca - no impacts, pending Orca updates that make use of the new field")),(0,r.yg)("h2",{id:"migration-from-prior-versions"},"Migration From Prior Versions"),(0,r.yg)("p",null,"Users migrating to the release using this feature will need to migrate their database to make use of and populate the new ",(0,r.yg)("inlineCode",{parentName:"p"},"producer_granule_id")," field in the Postgres database.  Details of this transition are documented in the ",(0,r.yg)("a",{parentName:"p",href:"/cumulus/docs/next/upgrade-notes/update-granules-to-include-producer_granule_id"},"upgrade notes document"),"."),(0,r.yg)("h3",{id:"existing-workflow-updates"},"Existing Workflow Updates"),(0,r.yg)("p",null,"For existing ingest workflows/processes not wishing to update, the only functional changes are:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"The framework (post workflow event driven writes) populating a granule's ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," granule field with the value from the ",(0,r.yg)("inlineCode",{parentName:"li"},"granuleId")," field if one is not provided as part of the ingest workflow."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://github.com/nasa/cumulus/blob/master/tasks/update-granules-cmr-metadata-file-links/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"UpdateGranulesCmrMetadataFileLinks"))," will update the CMR metadata to include the new ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," in the CMR metadata.")),(0,r.yg)("hr",null),(0,r.yg)("h2",{id:"core-changes"},"Core Changes"),(0,r.yg)("p",null,"The following sections detail changes to Cumulus Core as part of this feature:"),(0,r.yg)("h3",{id:"schema-changes"},"Schema Changes"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"granuleId")),": This field remains unchanged in the Core schema, and remains a unique identifier for a granule within the Cumulus system. For granules that originally had a different ",(0,r.yg)("inlineCode",{parentName:"li"},"granuleId")," via Cumulus Core Task Components or a provider provided identifier, this value will be a combination of the original ",(0,r.yg)("inlineCode",{parentName:"li"},"granuleId")," and a configurable hash.")),(0,r.yg)("p",null,"Downstream consumers of Cumulus granule objects should not need to make modifications related to this field.   Core will be moving away from API and other concepts that relate to identifying granule objects by ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," + ",(0,r.yg)("inlineCode",{parentName:"p"},"collectionId")," in future versions."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},(0,r.yg)("inlineCode",{parentName:"strong"},"producerGranuleId")),": This new field is intended to store the original, non-unique producer granule identification value.    This allows for traceability and correlation with the provider's source data.")),(0,r.yg)("p",null,"If using Cumulus Core reference Task Components this value will be retained from the original ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId"),".    If using another process, or the provider is providing uniquified IDs, it's expected that ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," will be populated with an appropriate value."),(0,r.yg)("p",null,"Downstream consumers of Cumulus granules objects should update to make use of this field if they intend to directly reference ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," or need to reconcile their records to provider records directly."),(0,r.yg)("h3",{id:"updated-movegranules-duplicate-handling-behavior"},"Updated ",(0,r.yg)("a",{parentName:"h3",href:"https://github.com/nasa/cumulus/blob/master/tasks/move-granules/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"MoveGranules"))," 'duplicate' handling behavior"),(0,r.yg)("p",null,"Move Granules was ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/pull/4003"},"updated")," to validate if an archive location object collision is due to a same-collection or cross-collection collision.    If the collision is cross-collection, it will fail ",(0,r.yg)("em",{parentName:"p"},"regardless")," of the collection configuration, to avoid inadvertent overwrites per requirements in IART-924."),(0,r.yg)("h3",{id:"updated-workflow-task-component-modifications"},"Updated Workflow Task Component Modifications"),(0,r.yg)("p",null,"The following tasks have been added or updated from prior versions to handle and/or allow conversion to use the new ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," field for this feature.  All Core workflow tasks that utilize a granule payload were updated to allow for producerGranuleId in the granule object schema, and are not individually listed here if that was the only update."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Please refer to the README and schemas for the tasks as the source of truth regarding configuration options, this information is true at the time of feature implementation"),":"),(0,r.yg)("h4",{id:"added"},"Added"),(0,r.yg)("h5",{id:"adduniquegranuleid"},(0,r.yg)("a",{parentName:"h5",href:"https://github.com/nasa/cumulus/blob/master/tasks/add-unique-granule-id/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"AddUniqueGranuleId"))),(0,r.yg)("p",null,"Task was added to provide a 'shim' option to allow for incoming granules without a producerGranuleId to be ",(0,r.yg)("inlineCode",{parentName:"p"},"uniqified")," as part of a workflow. A new ID is created and stored as the unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId"),", with the original ID in the incoming granule retained in the ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," field.   For details on the hashing approach used in this function see: ",(0,r.yg)("a",{parentName:"p",href:"/cumulus/docs/next/features/granule-id-hashing-approach"},"hashing approach document")),(0,r.yg)("h4",{id:"updated"},"Updated"),(0,r.yg)("h5",{id:"lzardsbackup"},(0,r.yg)("a",{parentName:"h5",href:"https://github.com/nasa/cumulus/blob/master/tasks/LZARDS-backup/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"LzardsBackup"))),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Task was updated to include ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," as part of the LZARDS ",(0,r.yg)("inlineCode",{parentName:"li"},"metadata")," object")),(0,r.yg)("h5",{id:"parsepdr"},(0,r.yg)("a",{parentName:"h5",href:"https://github.com/nasa/cumulus/blob/master/tasks/parse-pdr/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"ParsePdr"))),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Task was updated to take an optional configuration parameter ",(0,r.yg)("inlineCode",{parentName:"li"},"uniquifyGranules")," that if set to ",(0,r.yg)("inlineCode",{parentName:"li"},"true")," will update the granuleId for all found granules to have a unique granule hash appended to the existing ID   (",(0,r.yg)("a",{parentName:"li",href:"https://github.com/nasa/cumulus/pull/3983"},"PR #3968"),")."),(0,r.yg)("li",{parentName:"ul"},"Task was updated to always populate producerGranuleId for the output granule with the incoming producerGranuleId."),(0,r.yg)("li",{parentName:"ul"},"Task was updated to detect duplicate granuleIds and throw an error if uniquification is not enabled.")),(0,r.yg)("h5",{id:"queuegranules"},(0,r.yg)("a",{parentName:"h5",href:"https://github.com/nasa/cumulus/blob/master/tasks/queue-granules/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"QueueGranules"))),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Task was updated to set ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," to ",(0,r.yg)("inlineCode",{parentName:"li"},"granuleId")," if not set in the input granules (",(0,r.yg)("a",{parentName:"li",href:"https://github.com/nasa/cumulus/pull/3968"},"PR #3968"),")")),(0,r.yg)("h5",{id:"updategranulescmrmetadatafilelinks"},(0,r.yg)("a",{parentName:"h5",href:"https://github.com/nasa/cumulus/blob/master/tasks/update-granules-cmr-metadata-file-links/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"UpdateGranulesCmrMetadataFileLinks"))),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Task was updated to always set ",(0,r.yg)("inlineCode",{parentName:"li"},"granuleUR")," and ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," in the CMR metadata file based on the passed in granule. (",(0,r.yg)("a",{parentName:"li",href:"https://github.com/nasa/cumulus/pull/3997"},"PR #3997"),")")),(0,r.yg)("h5",{id:"filestogranules"},(0,r.yg)("a",{parentName:"h5",href:"https://github.com/nasa/cumulus/blob/master/tasks/files-to-granules/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"FilesToGranules"))),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Task was updated to allow ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," in the granule schema, and added ",(0,r.yg)("inlineCode",{parentName:"li"},"matchFilesWithProducerGranuleId")," as a configuration flag")),(0,r.yg)("h3",{id:"updated-cumulus-framework-behaviors"},"Updated Cumulus Framework Behaviors"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"The API will now allow for updates/writing of ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId"),".    This field is set either to the incoming value in the granule object ",(0,r.yg)("em",{parentName:"li"},"or")," defaults to the value for ",(0,r.yg)("inlineCode",{parentName:"li"},"granuleId"),"."),(0,r.yg)("li",{parentName:"ul"},"Granule PUT, GET, PATCH and POST will allow for ",(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," to be set."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"producerGranuleId")," will be output from all calls that output a granule object, and update SNS topics will report them to downstream consumers as well")),(0,r.yg)("h2",{id:"workflow-feature-use"},"Workflow Feature Use"),(0,r.yg)("h3",{id:"collection-configuration"},"Collection Configuration"),(0,r.yg)("p",null,"Most of the task Granule uniquification options in the updated task components can be enabled and configured at the collection level using ",(0,r.yg)("inlineCode",{parentName:"p"},"meta")," , or optionally be provided via workflow configuration or a rule ",(0,r.yg)("inlineCode",{parentName:"p"},"meta")," field."),(0,r.yg)("p",null,"As an example, collection oriented configuration can be achieved in the ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/tasks/add-unique-granule-id/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"AddUniqueGranuleId"))," implementations by adding the following to the ",(0,r.yg)("inlineCode",{parentName:"p"},"collection.meta")," object:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'"meta": {\n  "uniquifyGranuleId": true,\n  "hashLength": 8\n}\n\n')),(0,r.yg)("p",null,"Once you've done that, you can then add task configuration hooks to the workflow components that need configuration:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'     "AddUniqueGranuleId": {\n      "Parameters": {\n        "cma": {\n          "event.$": "$",\n          "ReplaceConfig": {\n            "Path": "$.payload",\n            "TargetPath": "$.payload"\n          },\n          "task_config": {\n            "hashLength": "{$.meta.collection.meta.hashLength}"\n          }\n        }\n      },\n')),(0,r.yg)("p",null,"If ",(0,r.yg)("inlineCode",{parentName:"p"},"uniquifyGranuleId")," is ",(0,r.yg)("inlineCode",{parentName:"p"},"true")," and the Collection is ingested using a workflow that includes the ",(0,r.yg)("inlineCode",{parentName:"p"},"AddUniqueGranuleId")," Task (required to update the granuleId), the ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," will be uniquely generated using the ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/packages/ingest/src/granule.ts"},(0,r.yg)("inlineCode",{parentName:"a"},"generateUniqueGranuleId")," function here"),". The ",(0,r.yg)("inlineCode",{parentName:"p"},"hashLength")," specifies how many characters the randomized hash contains. More characters offer a greater chance of uniqueness."),(0,r.yg)("p",null,(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/example/cumulus-tf/cnm_workflow.asl.json"},"Here is an example workflow configuration including the AddUniqueGranuleId task.")),(0,r.yg)("h4",{id:"collection-path-considerations"},"Collection Path Considerations"),(0,r.yg)("admonition",{type:"caution"},(0,r.yg)("p",{parentName:"admonition"},"A Collection that is configured to uniquely identify Granules in this way means that the existing ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," will change to a unique, hashed value. This is important to consider when building workflows and, in particular, specifying the S3 paths for a Granule's Files. ",(0,r.yg)("strong",{parentName:"p"},(0,r.yg)("em",{parentName:"strong"},"This is also true for all workflows that may be run with Granules that have previously had their ",(0,r.yg)("inlineCode",{parentName:"em"},"granuleId")," uniquely generated")))),(0,r.yg)("p",null,"In a Collection configuration, you can specify the ",(0,r.yg)("inlineCode",{parentName:"p"},"url_path")," template that will be used to determine the final location of the Collection's Files if using the  ",(0,r.yg)("inlineCode",{parentName:"p"},"MoveGranules")," Task Component."),(0,r.yg)("p",null,"If that path contains a ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," or anything derived from ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId"),", notably the CMR Metadata's ",(0,r.yg)("inlineCode",{parentName:"p"},"GranuleUR"),", that path will contain the unique value. An example containing the unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," might look like:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'"url_path": "{cmrMetadata.Granule.Collection.ShortName}___{cmrMetadata.Granule.Collection.VersionId}/{granule.granuleId}",\n')),(0,r.yg)("p",null,"or"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'"url_path": "{cmrMetadata.Granule.Collection.ShortName}___{cmrMetadata.Granule.Collection.VersionId}/{cmrMetadata.Granule.GranuleUR}",\n')),(0,r.yg)("p",null,"If that is NOT desirable and using the original, non-unique value is preferred, that is still possible. The Collection would need to be configured to use the ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId"),", which represents the original ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," value without any uniquification, or a completely different value."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'"url_path": "{cmrMetadata.Granule.Collection.ShortName}___{cmrMetadata.Granule.Collection.VersionId}/{granule.producerGranuleId}/",\n')),(0,r.yg)("p",null,"Taking it a step further, depending on the workflow configuration, users can specify a default using the ",(0,r.yg)("inlineCode",{parentName:"p"},"defaultTo")," operation if the ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId")," isn't available for a given Granule."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'"url_path": "{cmrMetadata.Granule.Collection.ShortName}___{cmrMetadata.Granule.Collection.VersionId}/{defaultTo(granule.producerGranuleId, granule.granuleId)}",\n')),(0,r.yg)("h3",{id:"workflow-configuration"},"Workflow Configuration"),(0,r.yg)("p",null,"An additional consideration to configuring the collection to uniquely identify granules is the record writing mechanism in the Cumulus Core framework."),(0,r.yg)("p",null,"When a workflow executes, records are written to the Cumulus datastore including ",(0,r.yg)("inlineCode",{parentName:"p"},"execution"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"granule"),", and ",(0,r.yg)("inlineCode",{parentName:"p"},"pdr")," (among others). These records are written and updated to reflect the stages of the workflow execution. Initially a ",(0,r.yg)("inlineCode",{parentName:"p"},"granule")," (for example) will be written in the ",(0,r.yg)("inlineCode",{parentName:"p"},"running")," state. As the workflow progresses, that ",(0,r.yg)("inlineCode",{parentName:"p"},"granule")," will be updated to either ",(0,r.yg)("inlineCode",{parentName:"p"},"completed")," or ",(0,r.yg)("inlineCode",{parentName:"p"},"failed"),". This presents a potential issue if the Cumulus workflow is generating a unique ID for the incoming granule as the initial write (a ",(0,r.yg)("inlineCode",{parentName:"p"},"granule")," written as ",(0,r.yg)("inlineCode",{parentName:"p"},"running"),") will happen ",(0,r.yg)("em",{parentName:"p"},"before")," the workflow task is able to generate the unique ID. The resulting record will reflect the original, non-unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," e.g."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "granuleId": "L2_HR_PIXC_A"\n}\n')),(0,r.yg)("p",null,"After the Granule has been assigned a unique ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," in the ",(0,r.yg)("inlineCode",{parentName:"p"},"add-unique-granuleID")," task the payload will look similar to this:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "granuleId": "L2_HR_PIXC_A_zHGdMM",\n  "producerGranuleId": "L2_HR_PIXC_A"\n}\n')),(0,r.yg)("p",null,"Where the ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," is now a unique value and the original ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," is stored as ",(0,r.yg)("inlineCode",{parentName:"p"},"producerGranuleId"),"."),(0,r.yg)("p",null,"In this case, it may be desirable to to ",(0,r.yg)("em",{parentName:"p"},"skip")," that initial record write as we do not want to attempt to write a granule with a ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId")," that 1. may conflict with another and 2. does not represent the final ",(0,r.yg)("inlineCode",{parentName:"p"},"granuleId"),", which could result in extraneous records."),(0,r.yg)("p",null,"To configure the workflow to skip that initial ",(0,r.yg)("inlineCode",{parentName:"p"},"granule")," write (when the granule is in the ",(0,r.yg)("inlineCode",{parentName:"p"},"running")," state), the workflow can be configured using the ",(0,r.yg)("inlineCode",{parentName:"p"},"sf_event_sqs_to_db_records_types")," block in the Terraform configuration. In this example using the ",(0,r.yg)("inlineCode",{parentName:"p"},"IngestAndPublishGranule")," workflow, the configuration would be:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},'{\n    sf_event_sqs_to_db_records_types = {\n        IngestAndPublishGranule = {\n            running = ["execution", "pdr"]\n        }\n    }\n}\n')),(0,r.yg)("p",null,(0,r.yg)("inlineCode",{parentName:"p"},"execution")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"pdr")," records will be written in the ",(0,r.yg)("inlineCode",{parentName:"p"},"running")," state. ",(0,r.yg)("inlineCode",{parentName:"p"},"granule")," will not because it is not specified. As of this writing, ",(0,r.yg)("inlineCode",{parentName:"p"},"execution")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"pdr")," must always be written. ",(0,r.yg)("inlineCode",{parentName:"p"},"granule")," is currently the only record type that can be skipped in this way. This behavior is subject to change in the future, see below documentation for the most current Record Write Options."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Important"),": If skipping the initial Granule record write is desired in a ",(0,r.yg)("strong",{parentName:"p"},"PDR workflow"),", additional modification may be required. See ",(0,r.yg)("a",{parentName:"p",href:"/cumulus/docs/next/features/record_write_options"},"the Record Write Options documentation")," for details on this use case as well as general documentation on skipping record writes."),(0,r.yg)("h3",{id:"workflow-examples"},"Workflow Examples"),(0,r.yg)("h4",{id:"sipspdr-based-workflow"},"SIPS/PDR Based Workflow"),(0,r.yg)("p",null,"Documentation in the ",(0,r.yg)("a",{parentName:"p",href:"/cumulus/docs/next/data-cookbooks/sips-workflow"},'"SIPS" Workflow Cookbook')," outlines an example usage of ",(0,r.yg)("inlineCode",{parentName:"p"},"DiscoverPDRs"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"QueuePDRs")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"ParsePDR")," in a workflow.  As mentioned above, uniquification should be a simple matter of configuring ",(0,r.yg)("inlineCode",{parentName:"p"},"ParsePDR")," with appropriate uniquification configuration values."),(0,r.yg)("h4",{id:"cnmkinesis-style-ingest-workflow"},"CNM/Kinesis Style Ingest Workflow"),(0,r.yg)("p",null,"Cumulus's integration deployment provides an example of a ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/example/cumulus-tf/cnm_workflow.asl.json"},(0,r.yg)("inlineCode",{parentName:"a"},"CNM")," style workflow")," which is detailed in a ",(0,r.yg)("a",{parentName:"p",href:"/cumulus/docs/next/data-cookbooks/cnm-workflow"},'"cookbook"')," that can be used for both uniquified and non-uniquified collections.   This workflow is a typical single-workflow ingest using a Kinesis stream that is triggering workflows with a CNM message, but it uses a choice state to configurably use the ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/tasks/add-unique-granule-id/README.md"},(0,r.yg)("inlineCode",{parentName:"a"},"AddUniqueGranuleId"))," task in the workflow for collections that are configured to handle this in-workflow:"),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"CNM Workflow Example",src:n(769020).A,width:"1181",height:"1401"})),(0,r.yg)("p",null,'Downstream steps have the relevant configuration values wired in from the collection configuration for steps that require it.  For example the integration test "ProcessingStep":'),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'"task_config": {\n            "bucket": "{$.meta.buckets.private.name}",\n            "collection": "{$.meta.collection}",\n            "cmrMetadataFormat": "{$.meta.cmrMetadataFormat}",\n            "additionalUrls": "{$.meta.additionalUrls}",\n            "matchFilesWithProducerGranuleId": "{$.meta.collection.meta.uniquifyGranuleId}"\n')))}c.isMDXComponent=!0}}]);