"use strict";(self.webpackChunk_cumulus_website=self.webpackChunk_cumulus_website||[]).push([[69617],{15680(e,n,t){t.d(n,{xA:()=>d,yg:()=>c});var a=t(296540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach(function(n){r(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var u=a.createContext({}),o=function(e){var n=a.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=o(e.components);return a.createElement(u.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef(function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,u=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=o(t),c=r,g=m["".concat(u,".").concat(c)]||m[c]||p[c]||l;return t?a.createElement(g,i(i({ref:n},d),{},{components:t})):a.createElement(g,i({ref:n},d))});function c(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=m;var s={};for(var u in n)hasOwnProperty.call(n,u)&&(s[u]=n[u]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var o=2;o<l;o++)i[o]=t[o];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},215660(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>u,default:()=>c,frontMatter:()=>s,metadata:()=>o,toc:()=>p});var a=t(58168),r=t(198587),l=(t(296540),t(15680)),i=["components"],s={id:"update-cumulus_id-type-indexes-CUMULUS-3449",title:"Update Cumulus_id Type and Indexes",hide_title:!1},u=void 0,o={unversionedId:"upgrade-notes/update-cumulus_id-type-indexes-CUMULUS-3449",id:"version-v18.4.0/upgrade-notes/update-cumulus_id-type-indexes-CUMULUS-3449",title:"Update Cumulus_id Type and Indexes",description:"Background",source:"@site/versioned_docs/version-v18.4.0/upgrade-notes/update-cumulus_id-type-indexes-CUMULUS-3449.md",sourceDirName:"upgrade-notes",slug:"/upgrade-notes/update-cumulus_id-type-indexes-CUMULUS-3449",permalink:"/cumulus/docs/v18.4.0/upgrade-notes/update-cumulus_id-type-indexes-CUMULUS-3449",draft:!1,tags:[],version:"v18.4.0",lastUpdatedBy:"Naga Nages",lastUpdatedAt:1724446966,formattedLastUpdatedAt:"Aug 23, 2024",frontMatter:{id:"update-cumulus_id-type-indexes-CUMULUS-3449",title:"Update Cumulus_id Type and Indexes",hide_title:!1},sidebar:"docs",previous:{title:"Upgrade Database Cluster to PostgreSQL v13",permalink:"/cumulus/docs/v18.4.0/upgrade-notes/upgrade-rds-cluster-tf-postgres-13"},next:{title:"Upgrade execution table to CUMULUS-3320",permalink:"/cumulus/docs/v18.4.0/upgrade-notes/upgrade_execution_table_CUMULUS_3320"}},d={},p=[{value:"Background",id:"background",level:2},{value:"Apply the Changes in Production Environment",id:"apply-the-changes-in-production-environment",level:2},{value:"Tools Used",id:"tools-used",level:2},{value:"Suggestions",id:"suggestions",level:2},{value:"Upgrade Steps",id:"upgrade-steps",level:2}],m={toc:p};function c(e){var n=e.components,t=(0,r.A)(e,i);return(0,l.yg)("wrapper",(0,a.A)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,l.yg)("h2",{id:"background"},"Background"),(0,l.yg)("p",null,"As part of the work for ",(0,l.yg)("a",{parentName:"p",href:"https://bugs.earthdata.nasa.gov/browse/CUMULUS-3449"},"CUMULUS-3449"),", LP DAAC (Land Processes Distributed\nActive Archive Center) have identified some Cumulus Core changes in regards to the database in order to improve query performance.\nFor other recommendations and considerations, see LP DAAC wiki\n",(0,l.yg)("a",{parentName:"p",href:"https://wiki.earthdata.nasa.gov/pages/viewpage.action?spaceKey=LPCUMULUS&title=Cumulus+RDS+Index+testing"},"Cumulus RDS Index testing"),"."),(0,l.yg)("p",null,"The following updates are included:"),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"Update some cumulus_id columns to BIGINT to allow future data grows and fix data type mismatch between primary key and foreign key. The columns are:"),(0,l.yg)("ul",{parentName:"li"},(0,l.yg)("li",{parentName:"ul"},"executions.cumulus_id"),(0,l.yg)("li",{parentName:"ul"},"executions.parent_cumulus_id"),(0,l.yg)("li",{parentName:"ul"},"files.granule_cumulus_id"),(0,l.yg)("li",{parentName:"ul"},"granules_executions.granule_cumulus_id"),(0,l.yg)("li",{parentName:"ul"},"granules_executions.execution_cumulus_id"),(0,l.yg)("li",{parentName:"ul"},"pdrs.execution_cumulus_id"))),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"Update indexes to provide the best chances of joins between tables"),(0,l.yg)("ul",{parentName:"li"},(0,l.yg)("li",{parentName:"ul"},"Change granules table unique constraint from\n",(0,l.yg)("inlineCode",{parentName:"li"},"granules_granule_id_collection_cumulus_id_unique UNIQUE (granule_id, collection_cumulus_id)"),"\nto\n",(0,l.yg)("inlineCode",{parentName:"li"},"granules_collection_cumulus_id_granule_id_unique UNIQUE (collection_cumulus_id, granule_id)")),(0,l.yg)("li",{parentName:"ul"},"Add indexes ",(0,l.yg)("inlineCode",{parentName:"li"},"granules_granule_id_index")," and ",(0,l.yg)("inlineCode",{parentName:"li"},"granules_provider_collection_cumulus_id_granule_id_index"),"\nto ",(0,l.yg)("inlineCode",{parentName:"li"},"granules")," table")))),(0,l.yg)("p",null,"The updates will be automatically created as part of the bootstrap lambda function on deployment of the data-persistence module."),(0,l.yg)("p",null,(0,l.yg)("em",{parentName:"p"},"In cases where the type update and indexes are already applied, the updates will have no effect.")),(0,l.yg)("h2",{id:"apply-the-changes-in-production-environment"},"Apply the Changes in Production Environment"),(0,l.yg)("p",null,"With large database (e.g. number of rows in executions table is greater than 100,000), the type updates and indexes must be applied manually since\nthe commands can take significant amount of time. Since these particular ALTER TABLE commands require an EXCLUSIVE LOCK on the table, it is recommended that\nall database activity be quiesced. This means that Ingest and Archive and other Cumulus functions must be shutdown before and during these commands."),(0,l.yg)("p",null,"The table below from LP DAAC provides the table sizes before and after ",(0,l.yg)("inlineCode",{parentName:"p"},"alter table")," commands, and timings.  LP DAAC has Aurora PostgreSQL 13.10."),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"Table Name"),(0,l.yg)("th",{parentName:"tr",align:null},"Original Table Size"),(0,l.yg)("th",{parentName:"tr",align:null},"ALTER Run Time (clock)"),(0,l.yg)("th",{parentName:"tr",align:null},"New Table Size"),(0,l.yg)("th",{parentName:"tr",align:null},"Number of Rows"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"executions"),(0,l.yg)("td",{parentName:"tr",align:null},"1.8 TB"),(0,l.yg)("td",{parentName:"tr",align:null},"41 hours"),(0,l.yg)("td",{parentName:"tr",align:null},"1.4 TB"),(0,l.yg)("td",{parentName:"tr",align:null},"374,170,855")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"files"),(0,l.yg)("td",{parentName:"tr",align:null},"1.2 TB"),(0,l.yg)("td",{parentName:"tr",align:null},"7.5 hours"),(0,l.yg)("td",{parentName:"tr",align:null},"850 GB"),(0,l.yg)("td",{parentName:"tr",align:null},"1,129,847,659")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},"granule_executions"),(0,l.yg)("td",{parentName:"tr",align:null},"20 GB"),(0,l.yg)("td",{parentName:"tr",align:null},"1 hours"),(0,l.yg)("td",{parentName:"tr",align:null},"13 GB"),(0,l.yg)("td",{parentName:"tr",align:null},"182,566,709")))),(0,l.yg)("h2",{id:"tools-used"},"Tools Used"),(0,l.yg)("p",null,"Since the update commands can take several hours to run based on table size and IO throughput, it is recommended that the commands are run in an EC2 instance\nin the AWS environment in a tmux or screen session. This will minimize the number of network hops and potential disconnects between the database client\nand the database. In addition, this will allow operators applying the patch to check on progress periodically and not worry about credential expiration or\nother issues that would result in the client being killed."),(0,l.yg)("p",null,"There are many available resources for tmux and the psql client. The following is for your referrence."),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("a",{parentName:"li",href:"https://www.postgresql.org/docs/13/app-psql.html"},"PostgreSQL Documentation")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("a",{parentName:"li",href:"https://www.linuxtrainingacademy.com/tmux-tutorial/"},"Tmux tutorial"))),(0,l.yg)("p",null,"Basic commands for running SQL commands"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-sh"},"# Start a tmux session called CumulusUpgrade with a new window named Fix-DataTypes\ntmux new -s CumulusUpgrade -n Fix-DataTypes\n \n# Start a PosgreSQL client section on the writer instance of the database cluster and prompt for password\npsql -h <Endpoint for writer instance> -p <Port for database or 5432> -d <cumulus database name or postgres> -U <database admin user or postgres> -W\n  \n# Open a new window to use for monitoring\n<Ctrl>-b c\n \n# Switch between windows\n# Last window\n<Ctrl>-b l\n\n# Next Window\n<Ctrl>-b n\n \n# Detach from tmux session\n<Ctrl>-b d\n \n# List tmux sessions\ntmux ls\n\n# Reattach to the session, you will see the windows again\ntmux attach -t CumulusUpgrade\n\n# Exit the window and/or close/kill the session\n# Warning: Don't close/kill the session until the task is complete\nexit\n# or\n<Ctrl>-b x\n")),(0,l.yg)("h2",{id:"suggestions"},"Suggestions"),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"Backup database before applying the updates, see the\n",(0,l.yg)("a",{parentName:"p",href:"https://nasa.github.io/cumulus/docs/features/backup_and_restore/#postgres-database"},"Backup and Restore document"),".")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"To get a more accurate downtime estimate, you can take a snapshot of your database, and run the migration on it.")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("p",{parentName:"li"},"This upgrade should work on prior Cumulus releases, so the upgrade can be performed when maintenance windown allows\nwithout having to upgrade Cumulus."))),(0,l.yg)("h2",{id:"upgrade-steps"},"Upgrade Steps"),(0,l.yg)("ol",null,(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("p",{parentName:"li"},"Quiesce ingest"),(0,l.yg)("p",{parentName:"li"},"Stop all ingest operations in Cumulus Core according to your operational procedures. You should validate\nthat it appears there are no active queries that appear to be inserting granules/files into the database\nas a secondary method of evaluating the database system state:"),(0,l.yg)("pre",{parentName:"li"},(0,l.yg)("code",{parentName:"pre",className:"language-text"},"select pid, query, state, wait_event_type, wait_event from pg_stat_activity where state = 'active';\n")),(0,l.yg)("p",{parentName:"li"},"If query rows are returned with a ",(0,l.yg)("inlineCode",{parentName:"p"},"query")," value that involves the tables, make sure ingest is halted\nand no other granule-update activity is running on the system."),(0,l.yg)("p",{parentName:"li"},"Note: In rare instances if there are hung queries that are unable to resolve, it may be necessary to\nmanually use psql ",(0,l.yg)("a",{parentName:"p",href:"https://www.postgresql.org/docs/13/functions-admin.html#FUNCTIONS-ADMIN-SIGNAL"},"Server Signaling\nFunctions"),"\n",(0,l.yg)("inlineCode",{parentName:"p"},"pg_cancel_backend")," and/or\n",(0,l.yg)("inlineCode",{parentName:"p"},"pg_terminate_backend")," to end the queries.")),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("p",{parentName:"li"},"Login into EC2 instance with database access."),(0,l.yg)("p",{parentName:"li"},"From AWS console: Go to EC2, pick a ",(0,l.yg)("inlineCode",{parentName:"p"},"<prefix>-CumulusECSCluster")," instance, click Connect, click Session Manager\nand click the Connect button."),(0,l.yg)("p",{parentName:"li"},"From AWS CLI: aws ssm start-session --target ",(0,l.yg)("inlineCode",{parentName:"p"},"EC2 Instance ID"),"."),(0,l.yg)("admonition",{parentName:"li",title:"Remember to take a note on which instance you run the commands.",type:"note"})),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("p",{parentName:"li"},"Install tmux and postgres client"),(0,l.yg)("pre",{parentName:"li"},(0,l.yg)("code",{parentName:"pre",className:"language-sh"},"sudo yum install -y tmux\nsudo amazon-linux-extras install postgresql13\n")),(0,l.yg)("p",{parentName:"li"},"Once installed, a tmux session is started with two windows. The Cumulus database is connected to in each window\nusing the PostgreSQL client. The primary window is used for running the ALTER commands, while the secondary window\nis used to monitor the database and alter statement. When the operator hits end of shift or is done monitoring for\nthe day, the tmux session can be detached from and reattached to at a later time.")),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("p",{parentName:"li"},"Run SQL Commands\nThe database login credentials can be retrieved from the prefix_db_login secret.\nWhen the SQL commands are running, perform step 5 to monitor the commands."),(0,l.yg)("pre",{parentName:"li"},(0,l.yg)("code",{parentName:"pre",className:"language-sh"},"tmux new-session -s CumulusUpgrade -n Fix-DataTypes\n\npsql -h <Endpoint for writer instance> -p <Port for database or 5432> -d <cumulus database name> -U <database admin user> -W\n#e.g. psql -h cumulus-dev-rds-cluster.cluster-xxx.us-east-1.rds.amazonaws.com -p 5432 -d cumulus_test_db -U cumulus_test -W\n\n# Use -f option to run the SQL commands from a file\npsql -h <Endpoint for writer instance> -p <Port for database or 5432> -d <cumulus database name> -U <database admin user> -f 20240124101001_update_cumulus_id_add_indexes.sql -W\n")),(0,l.yg)("p",{parentName:"li"},"The following are SQL commands, and 20240124101001_update_cumulus_id_add_indexes.sql is available\n",(0,l.yg)("a",{parentName:"p",href:"https://raw.githubusercontent.com/nasa/cumulus/master/packages/db/src/migrations/20240124101001_update_cumulus_id_add_indexes.sql"},"here"),":"),(0,l.yg)("pre",{parentName:"li"},(0,l.yg)("code",{parentName:"pre",className:"language-sql"},"-- Update column types\nSELECT CURRENT_TIMESTAMP;\nALTER TABLE executions ALTER COLUMN cumulus_id TYPE BIGINT, ALTER COLUMN parent_cumulus_id TYPE BIGINT;\nSELECT CURRENT_TIMESTAMP;\nALTER TABLE files ALTER COLUMN granule_cumulus_id TYPE BIGINT;\nSELECT CURRENT_TIMESTAMP;\nALTER TABLE granules_executions ALTER COLUMN granule_cumulus_id TYPE BIGINT, ALTER COLUMN execution_cumulus_id TYPE BIGINT;\nSELECT CURRENT_TIMESTAMP;\nALTER TABLE pdrs ALTER COLUMN execution_cumulus_id TYPE BIGINT;\nSELECT CURRENT_TIMESTAMP;\n\nVACUUM (ANALYZE, VERBOSE) executions;\nSELECT CURRENT_TIMESTAMP;\nVACUUM (ANALYZE, VERBOSE) files;\nSELECT CURRENT_TIMESTAMP;\nVACUUM (ANALYZE, VERBOSE) granules_executions;\nSELECT CURRENT_TIMESTAMP;\nVACUUM (ANALYZE, VERBOSE) pdrs;\nSELECT CURRENT_TIMESTAMP;\n\n-- Update and Add indexes\nCREATE UNIQUE INDEX CONCURRENTLY IF NOT EXISTS granules_collection_cumulus_id_granule_id_unique ON granules(collection_cumulus_id, granule_id);\nSELECT CURRENT_TIMESTAMP;\nCREATE INDEX CONCURRENTLY IF NOT EXISTS granules_granule_id_index ON granules(granule_id);\nSELECT CURRENT_TIMESTAMP;\nCREATE INDEX CONCURRENTLY IF NOT EXISTS granules_provider_collection_cumulus_id_granule_id_index ON granules(provider_cumulus_id, collection_cumulus_id, granule_id);\nSELECT CURRENT_TIMESTAMP;\n"))),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("p",{parentName:"li"},"Monitor the Running Command"),(0,l.yg)("pre",{parentName:"li"},(0,l.yg)("code",{parentName:"pre",className:"language-sh"},"# From tmux CumulusUpgrade session, open another window\n<Ctrl>-b c\n\npsql -h <Endpoint for writer instance> -p <Port for database or 5432> -d <cumulus database name> -U <database admin user> -W\n\nselect pid, query, state, wait_event_type, wait_event from pg_stat_activity where state = 'active';\n"))),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("p",{parentName:"li"},"Verify the Updates"),(0,l.yg)("p",{parentName:"li"}," We can verify that the tables are updated successfully by checking the ",(0,l.yg)("inlineCode",{parentName:"p"},"\\d table")," results from psql.  The following are expected results."),(0,l.yg)("pre",{parentName:"li"},(0,l.yg)("code",{parentName:"pre",className:"language-sh"},'=> \\d executions;\n\n          Column           |           Type           | Collation | Nullable |                    Default                     \n----------------------------+--------------------------+-----------+----------+------------------------------------------------\ncumulus_id                 | bigint                   |           | not null | nextval(\'executions_cumulus_id_seq\'::regclass)\nparent_cumulus_id          | bigint                   |           |          | \n\n=> \\d granules_executions;\n\n        Column        |  Type  | Collation | Nullable | Default \n----------------------+--------+-----------+----------+---------\ngranule_cumulus_id   | bigint |           | not null | \nexecution_cumulus_id | bigint |           | not null | \n\n=> \\d files;\n                                               \n      Column       |           Type           | Collation | Nullable |                  Default                  \n--------------------+--------------------------+-----------+----------+-------------------------------------------\ngranule_cumulus_id | bigint                   |           | not null | \n\n=> \\d granules;\n\nIndexes:\n"granules_collection_cumulus_id_granule_id_unique" UNIQUE, btree (collection_cumulus_id, granule_id)\n"granules_granule_id_index" btree (granule_id)\n"granules_provider_collection_cumulus_id_granule_id_index" btree (provider_cumulus_id, collection_cumulus_id, granule_id)\n\n=> \\d pdrs\n\n        Column         |           Type           | Collation | Nullable |                 Default                  \n-----------------------+--------------------------+-----------+----------+------------------------------------------\nexecution_cumulus_id  | bigint                   |           |          | \n'))),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("p",{parentName:"li"},"Close the Session"),(0,l.yg)("p",{parentName:"li"},"Close the tmux session after the task is complete by ",(0,l.yg)("inlineCode",{parentName:"p"},"exit")," or ",(0,l.yg)("inlineCode",{parentName:"p"},"<Ctrl>-b x"),"."))))}c.isMDXComponent=!0}}]);