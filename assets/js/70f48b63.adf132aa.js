"use strict";(self.webpackChunk_cumulus_website=self.webpackChunk_cumulus_website||[]).push([[10507],{685:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>c,frontMatter:()=>s,metadata:()=>u,toc:()=>g});var i=n(58168),o=n(98587),a=(n(96540),n(15680)),r=["components"],s={id:"troubleshooting-database-migrations",title:"Troubleshooting Database Migrations",hide_title:!1},l=void 0,u={unversionedId:"troubleshooting/troubleshooting-database-migrations",id:"version-v20.1.0/troubleshooting/troubleshooting-database-migrations",title:"Troubleshooting Database Migrations",description:"This document provides guidance on how to troubleshoot database migration when upgrading to v18.5.1.",source:"@site/versioned_docs/version-v20.1.0/troubleshooting/troubleshoot_database_migration.md",sourceDirName:"troubleshooting",slug:"/troubleshooting/troubleshooting-database-migrations",permalink:"/cumulus/docs/troubleshooting/troubleshooting-database-migrations",draft:!1,tags:[],version:"v20.1.0",lastUpdatedBy:"Tim Clark",lastUpdatedAt:1742895702,formattedLastUpdatedAt:"Mar 25, 2025",frontMatter:{id:"troubleshooting-database-migrations",title:"Troubleshooting Database Migrations",hide_title:!1},sidebar:"docs",previous:{title:"Reindexing Elasticsearch Guide",permalink:"/cumulus/docs/troubleshooting/reindex-elasticsearch"},next:{title:"Cumulus Development",permalink:"/cumulus/docs/category/cumulus-development"}},d={},g=[{value:"Failing Database Migrations",id:"failing-database-migrations",level:2},{value:"Discerning Failing Migrations",id:"discerning-failing-migrations",level:3},{value:"Next Steps",id:"next-steps",level:3},{value:"Other potential issues",id:"other-potential-issues",level:3},{value:"Miscellaneous",id:"miscellaneous",level:3}],p={toc:g},m="wrapper";function c(e){var t=e.components,n=(0,o.A)(e,r);return(0,a.yg)(m,(0,i.A)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.yg)("p",null,"This document provides guidance on how to troubleshoot database migration when upgrading to v18.5.1."),(0,a.yg)("admonition",{type:"info"},(0,a.yg)("p",{parentName:"admonition"},"This document is specifically intended to provide a potential resolution for issues with the database migration to v18.5.1+.\nThe advice in this document may be used for migrations to other versions, but please be mindful they may not provide the same resolution.")),(0,a.yg)("h2",{id:"failing-database-migrations"},"Failing Database Migrations"),(0,a.yg)("p",null,"When trying to deploy the v18.5.1 of Cumulus, specifically the ",(0,a.yg)("inlineCode",{parentName:"p"},"data-persistence-tf")," module, there is a chance the terraform deployment task times out. The timeout usually occurs when the ",(0,a.yg)("inlineCode",{parentName:"p"},"<prefix>-postgres-db-migration")," lambda is invoked. It will attempt to run the migrations, which may take longer than the Lambda's timeout allows. This occurs when the lambda is trying to run a new migration that has not already been applied (e.g. is NOT in the PostgreSQL ",(0,a.yg)("inlineCode",{parentName:"p"},"Migrations Table"),")."),(0,a.yg)("h3",{id:"discerning-failing-migrations"},"Discerning Failing Migrations"),(0,a.yg)("p",null,"The issue can be resolved by simply skipping the offending migration. To see which migration that is; you can query the PostgreSQL ",(0,a.yg)("inlineCode",{parentName:"p"},"knex_migrations")," table and compare them to the ones you should have in your release (in this case 18.5.1). If one or more migrations is missing, that migration is potentially taking too long for the Lambda and causing issues."),(0,a.yg)("h3",{id:"next-steps"},"Next Steps"),(0,a.yg)("p",null,"When you discover which migration(s) are missing from the ",(0,a.yg)("inlineCode",{parentName:"p"},"Migrations Table"),". These steps can be taken to resolve:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},"- Manually apply the migration (ex. `update_executions_deletion_constraint`) using SQL applied directly to your database. The SQL commands can be found in the `db` package of the Cumulus codebase\n- Manually add the entry into the `knex_migrations` table. Subsequent runs of the `<prefix>-postgres-db-migration` Lambda will check this table and skip any migrations listed. This means that your manual SQL updates will be respected and the Lambda will not try to process the same migration.\n- Re-deploy `data-persistence-tf` after verifying the above successfully completed\n")),(0,a.yg)("h3",{id:"other-potential-issues"},"Other potential issues"),(0,a.yg)("p",null,"Migration Lambda timeouts (or other related timeouts) may be caused by ",(0,a.yg)("inlineCode",{parentName:"p"},"VACUUM")," statements in the migration. If you find your deployment not completing despite the migration table and the migrations being consistent, this may be the issue. In v18.5.2, some ",(0,a.yg)("inlineCode",{parentName:"p"},"VACUUM")," statements have been removed to tailor for this issue. If you find yourself struggling with v18.5.1 despite completing the above steps, please upgrade to v18.5.2 and try deployment again. The removal of potentially long-running migrations may resolve the issue."),(0,a.yg)("h3",{id:"miscellaneous"},"Miscellaneous"),(0,a.yg)("p",null,"If the instructions in this document are not helping you with your issues(s) reagarding troubleshooting database migration, please contact the Cumulus Team for support."))}c.isMDXComponent=!0},15680:(e,t,n)=>{n.d(t,{xA:()=>d,yg:()=>c});var i=n(96540);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,o=function(e,t){if(null==e)return{};var n,i,o={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=i.createContext({}),u=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=u(e.components);return i.createElement(l.Provider,{value:t},e.children)},g="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),g=u(n),m=o,c=g["".concat(l,".").concat(m)]||g[m]||p[m]||a;return n?i.createElement(c,r(r({ref:t},d),{},{components:n})):i.createElement(c,r({ref:t},d))}));function c(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,r=new Array(a);r[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[g]="string"==typeof e?e:o,r[1]=s;for(var u=2;u<a;u++)r[u]=n[u];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);