"use strict";(self.webpackChunk_cumulus_website=self.webpackChunk_cumulus_website||[]).push([[9374],{15680:(e,a,n)=>{n.d(a,{xA:()=>d,yg:()=>f});var t=n(296540);function r(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function i(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter(function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable})),n.push.apply(n,t)}return n}function o(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach(function(a){r(e,a,n[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach(function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))})}return e}function l(e,a){if(null==e)return{};var n,t,r=function(e,a){if(null==e)return{};var n,t,r={},i=Object.keys(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||(r[n]=e[n]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=t.createContext({}),u=function(e){var a=t.useContext(s),n=a;return e&&(n="function"==typeof e?e(a):o(o({},a),e)),n},d=function(e){var a=u(e.components);return t.createElement(s.Provider,{value:a},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},p=t.forwardRef(function(e,a){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),m=u(n),p=r,f=m["".concat(s,".").concat(p)]||m[p]||c[p]||i;return n?t.createElement(f,o(o({ref:a},d),{},{components:n})):t.createElement(f,o({ref:a},d))});function f(e,a){var n=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=p;var l={};for(var s in a)hasOwnProperty.call(a,s)&&(l[s]=a[s]);l.originalType=e,l[m]="string"==typeof e?e:r,o[1]=l;for(var u=2;u<i;u++)o[u]=n[u];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}p.displayName="MDXCreateElement"},453983:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>d,contentTitle:()=>s,default:()=>f,frontMatter:()=>l,metadata:()=>u,toc:()=>m});var t=n(58168),r=n(198587),i=(n(296540),n(15680)),o=["components"],l={id:"lambda_versioning",title:"Lambda Versioning",hide_title:!0},s="Lambda Versioning",u={unversionedId:"features/lambda_versioning",id:"version-v9.0.0/features/lambda_versioning",title:"Lambda Versioning",description:"Cumulus makes use of AWS's Lambda/Alias version objects to tag and retain references to recent copies of deployed workflow lambdas.",source:"@site/versioned_docs/version-v9.0.0/features/lambda_versioning.md",sourceDirName:"features",slug:"/features/lambda_versioning",permalink:"/cumulus/docs/v9.0.0/features/lambda_versioning",draft:!1,tags:[],version:"v9.0.0",lastUpdatedBy:"jennyhliu",lastUpdatedAt:1678406688,formattedLastUpdatedAt:"Mar 10, 2023",frontMatter:{id:"lambda_versioning",title:"Lambda Versioning",hide_title:!0},sidebar:"docs",previous:{title:"Reconciliation Reports",permalink:"/cumulus/docs/v9.0.0/features/reports"},next:{title:"Ancillary Metadata Export",permalink:"/cumulus/docs/v9.0.0/features/ancillary_metadata"}},d={},m=[{value:"Configuration",id:"configuration",level:2},{value:"s3Source Lambda Version Configuration",id:"s3source-lambda-version-configuration",level:3},{value:"Changing Number of Retained Lambdas",id:"changing-number-of-retained-lambdas",level:3},{value:"Disabling Lambda Versioning",id:"disabling-lambda-versioning",level:3}],c={toc:m},p="wrapper";function f(e){var a=e.components,n=(0,r.A)(e,o);return(0,i.yg)(p,(0,t.A)({},c,n,{components:a,mdxType:"MDXLayout"}),(0,i.yg)("h1",{id:"lambda-versioning"},"Lambda Versioning"),(0,i.yg)("p",null,"Cumulus makes use of AWS's Lambda/Alias version objects to tag and retain references to recent copies of deployed workflow lambdas."),(0,i.yg)("p",null,"All Cumulus deployed lambdas in lambdas.yml will have an alias/version resource created. Lambdas with source coming from S3 must be expressly configured to take advantage of versioning."),(0,i.yg)("p",null,"A reference to the most current lambda version alias will replace the unversioned lambda resource ARN in all workflows for each task that is either built via Cumulus, or defined via the uniqueIdentifier configuration key for s3 sourced lambdas."),(0,i.yg)("p",null,"A configurable number of previously deployed alias/version pairs will be retained to ensure that in-progress workflows are able to complete."),(0,i.yg)("p",null,"This allows for workflows to automatically reference the specific version of a lambda function they were deployed with, prevents an updated deployment of an existing lambda from being utilized in an already in-progress workflow, and retains the executed version information in the AWS step function execution record and CloudWatch logs."),(0,i.yg)("p",null,(0,i.yg)("strong",{parentName:"p"},"Please note")," that care must be exercised to not update lambda versions and redeploy frequently enough that an in-progress workflow refers to an aged-off version of a lambda, or workflows that reference such a lambda may fail."),(0,i.yg)("p",null,(0,i.yg)("strong",{parentName:"p"},"Please note")," This feature is not currently compatible with utilizing the ",(0,i.yg)("inlineCode",{parentName:"p"},"layers")," key in workflow lambdas, as updates/reconfiguration of lambda layers will not result in a new version being created by kes.   See ",(0,i.yg)("a",{parentName:"p",href:"https://bugs.earthdata.nasa.gov/browse/CUMULUS-1197"},"CUMULUS-1197")," for more information."),(0,i.yg)("p",null,"( See ",(0,i.yg)("a",{parentName:"p",href:"https://docs.aws.amazon.com/lambda/latest/dg/versioning-aliases.html"},"AWS Lambda Function Versioning and Aliases")," for more on lambda versions/aliases)"),(0,i.yg)("h2",{id:"configuration"},"Configuration"),(0,i.yg)("p",null,"This feature is enabled by default for all Cumulus built/deployed lambdas, as well as s3Source lambdas that are configured as described below.  s3Source Lambdas that are not configured will continue to utilize an unqualified reference and will not utilize lambda versioning."),(0,i.yg)("h3",{id:"s3source-lambda-version-configuration"},"s3Source Lambda Version Configuration"),(0,i.yg)("p",null,"Lambdas with s3Source defined currently require additional configuration to make use of this feature in the form of a 'uniqueIdentifier' key:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"SomeLambda:\n  Handler: lambda_handler.handler\n  timeout: 300\n  s3Source:\n    bucket: '{{some_bucket}}'\n    key: path/some-lambda.zip\n    uniqueIdentifier: '5dot2'\n  runtime: python2.7\n")),(0,i.yg)("p",null,"That key, due to AWS constraints, must be letters (",(0,i.yg)("inlineCode",{parentName:"p"},"[a-zA-Z]"),") only."),(0,i.yg)("h3",{id:"changing-number-of-retained-lambdas"},"Changing Number of Retained Lambdas"),(0,i.yg)("p",null,"The default number of retained lambda versions is 1."),(0,i.yg)("p",null,"This can be overridden by adding the following key to your configuration file:"),(0,i.yg)("p",null,(0,i.yg)("inlineCode",{parentName:"p"},"maxNumberOfRetainedLambdas: X")),(0,i.yg)("p",null,"where X is the number of previous versions you wish to retain."),(0,i.yg)("p",null,"This feature allows a variable number of retained lambdas, however due to CloudFormation limits and current implementation constraints, that number is fairly limited."),(0,i.yg)("p",null,"The ",(0,i.yg)("inlineCode",{parentName:"p"},"WorkflowLambdaVersions")," sub-template is constrained to 200 total resources, in addition to only being able to output 60 aliases back to the master template.   As such, the limit on the template is:"),(0,i.yg)("p",null,(0,i.yg)("inlineCode",{parentName:"p"},"(200/2+2*RV)-2")," where RV = total number of retained versions."),(0,i.yg)("p",null,"Given the available limits, the following are the pratical limits on the number of lambdas that can be configured for a given number of retained lambdas:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"1: 48")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"2: 31")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"3: 23"))),(0,i.yg)("h3",{id:"disabling-lambda-versioning"},"Disabling Lambda Versioning"),(0,i.yg)("p",null,"This feature is enabled by default in the deployment package template, but can be disabled by adding the following key to your app/config.yml:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"useWorkflowLambdaVersions: false\n")),(0,i.yg)("p",null,"Disabling this feature will result in Cumulus not creating alias/version lambda resource objects, the ",(0,i.yg)("inlineCode",{parentName:"p"},"WorkflowLambdaVersions")," stack will not be created and the deployed workflow lambda references will be unqualified (always referring to the latest version)."),(0,i.yg)("p",null,"Disabling this feature after deploying a stack with it enabled will remove the ",(0,i.yg)("inlineCode",{parentName:"p"},"WorkflowLambdaVersions")," stack, remove all Cumulus defined lambda Version/Alias pairs and reset all workflows to using an unqualified lambda reference.     Workflows in progress with incomplete steps that have references to versioned lambdas will fail."))}f.isMDXComponent=!0}}]);