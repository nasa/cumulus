
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>CNM Workflow Â· Cumulus Documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="error-handling.html" />
    
    
    <link rel="prev" href="sips-workflow.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Documentation</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Home
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../architecture.html">
            
                <a href="../architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../workflows/">
            
                <a href="../workflows/">
            
                    
                    What are Cumulus Workflows?
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../workflows/protocol.html">
            
                <a href="../workflows/protocol.html">
            
                    
                    Workflow Protocol
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../tasks.html">
            
                <a href="../tasks.html">
            
                    
                    Workflow Tasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../workflows/input_output.html">
            
                <a href="../workflows/input_output.html">
            
                    
                    Workflow Input & Ouptut
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../workflows/cumulus-task-message-flow.html">
            
                <a href="../workflows/cumulus-task-message-flow.html">
            
                    
                    Workflow Task Message Flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../workflows/developing-workflow-tasks.html">
            
                <a href="../workflows/developing-workflow-tasks.html">
            
                    
                    Developing Workflow Tasks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1" data-path="../workflows/lambda.html">
            
                <a href="../workflows/lambda.html">
            
                    
                    Lambda Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.2" data-path="../workflows/docker.html">
            
                <a href="../workflows/docker.html">
            
                    
                    Dockerization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../workflows/workflow-configuration-how-to.html">
            
                <a href="../workflows/workflow-configuration-how-to.html">
            
                    
                    Workflow Configuration How-to's
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../workflows/workflow-triggers.html">
            
                <a href="../workflows/workflow-triggers.html">
            
                    
                    Workflow Triggers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Deployment
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../deployment/">
            
                <a href="../deployment/">
            
                    
                    How to Deploy Cumulus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../deployment/create_bucket.html">
            
                <a href="../deployment/create_bucket.html">
            
                    
                    Creating an S3 Bucket
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../deployment/iam_roles.html">
            
                <a href="../deployment/iam_roles.html">
            
                    
                    Locating IAMs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../deployment/troubleshoot_deployment.html">
            
                <a href="../deployment/troubleshoot_deployment.html">
            
                    
                    Troubleshooting Deployment
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <a target="_blank" href="https://nasa.github.io/cumulus-api">
            
                    
                    Cumulus API Docs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Additional Cumulus Features
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../data_in_dynamodb.html">
            
                <a href="../data_in_dynamodb.html#cumulus-metadata-in-dynamodb">
            
                    
                    Cumulus Metadata in DynamoDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../data_in_dynamodb.html">
            
                <a href="../data_in_dynamodb.html#backup-and-restore-with-aws">
            
                    
                    DynamoDB Backup and Restore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../data_in_dynamodb.html">
            
                <a href="../data_in_dynamodb.html#dynamodb-auto-scaling">
            
                    
                    DynamoDB Auto Scaling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../ems_reporting.html">
            
                <a href="../ems_reporting.html">
            
                    
                    EMS Reporting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../lambda_versioning.html">
            
                <a href="../lambda_versioning.html">
            
                    
                    Lambda Versioning
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <a target="_blank" href="https://github.com/nasa/cumulus/blob/master/CHANGELOG.md">
            
                    
                    Changelog
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../upgrade/">
            
                <a href="../upgrade/">
            
                    
                    Upgrade Instructions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../upgrade/1.6.0.html">
            
                <a href="../upgrade/1.6.0.html">
            
                    
                    1.6.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../upgrade/1.7.0.html">
            
                <a href="../upgrade/1.7.0.html">
            
                    
                    1.7.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../upgrade/1.9.0.html">
            
                <a href="../upgrade/1.9.0.html">
            
                    
                    1.9.0
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../system-documentation/system-documentation.html">
            
                <a href="../system-documentation/system-documentation.html">
            
                    
                    Operating and Troubleshooting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../doc_installation.html">
            
                <a href="../doc_installation.html">
            
                    
                    Contributing to documentation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../adding-a-task.html">
            
                <a href="../adding-a-task.html">
            
                    
                    Contributing a task
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../team.html">
            
                <a href="../team.html">
            
                    
                    Team
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Data Cookbook</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="about-cookbooks.html">
            
                <a href="about-cookbooks.html">
            
                    
                    About Cookbooks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="setup.html">
            
                <a href="setup.html">
            
                    
                    Collections, Providers, Schemas, and Rules
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="hello-world.html">
            
                <a href="hello-world.html">
            
                    
                    HelloWorldWorkflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="sns.html">
            
                <a href="sns.html">
            
                    
                    SNS Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="sips-workflow.html">
            
                <a href="sips-workflow.html">
            
                    
                    SIPS Workflow
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.5" data-path="cnm-workflow.html">
            
                <a href="cnm-workflow.html">
            
                    
                    CNM Workflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="error-handling.html">
            
                <a href="error-handling.html">
            
                    
                    Error Handling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="choice-states.html">
            
                <a href="choice-states.html">
            
                    
                    Choice States
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >CNM Workflow</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="cnm-workflow">CNM Workflow</h1>
<p>This entry documents how to setup a workflow that utilizes the built-in CNM/Kinesis functionality in Cumulus.</p>
<p>Prior to working through this entry you should be familiar with the <a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cloud+Notification+Mechanism" target="_blank">Cloud Notification Mechanism</a>.</p>
<h2 id="sections">Sections:</h2>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#configure-the-workflow">Configure the Workflow</a></li>
<li><a href="#execute-the-workflow">Execute the Workflow</a></li>
<li><a href="#verify-results">Verify Results</a></li>
<li><a href="#kinesis-record-error-handling">Kinesis Record Error Handling</a></li>
</ul>
<hr>
<h2 id="prerequisites">Prerequisites</h2>
<h4 id="cumulus">Cumulus</h4>
<p>This entry assumes you have a deployed instance of Cumulus (&gt;= version 1.8).</p>
<h4 id="aws-cli">AWS CLI</h4>
<p>This entry assumes you have the <a href="https://aws.amazon.com/cli/" target="_blank">AWS CLI</a> installed and configured. If you do not, please take a moment to review the documentation - particularly the <a href="https://docs.aws.amazon.com/streams/latest/dev/fundamental-stream.html" target="_blank">examples relevant to Kinesis</a> - and install it now.</p>
<h4 id="kinesis">Kinesis</h4>
<p>This entry assumes you already have two <a href="https://aws.amazon.com/kinesis/" target="_blank">Kinesis</a> data steams created for use as CNM notification and response data streams.</p>
<p>If you do not have two streams setup, please take a moment to review the <a href="https://aws.amazon.com/documentation/kinesis/" target="_blank">Kinesis documentation</a> and setup two basic single-shard streams for this example:</p>
<p>Using the &quot;Create Data Stream&quot; button on the <a href="https://console.aws.amazon.com/kinesis/home" target="_blank">Kinesis Dashboard</a>, work through the dialogue.</p>
<p>You should be able to quickly use the &quot;Create Data Stream&quot; button on the <a href="https://console.aws.amazon.com/kinesis/home" target="_blank">Kinesis Dashboard</a>, and setup streams that are similar to the following example:</p>
<p><img src="../images/cnm_create_kinesis_stream.jpg" alt=""></p>
<p>Please bear in mind that your <code>${stackname}-lambda-processing</code> IAM role will need permissions to write to the response stream for this workflow to succeed if you create the Kinesis stream with a dashboard user.   If you are using the example deployment (or a deployment based on it), the IAM permissions should be set properly.</p>
<p>If not, the most straightforward approach is to attach the <code>AmazonKinesisFullAccess</code> policy for the stream resource to whatever role your lambdas are using, however your environment/security policies may require an approach specific to your deployment environment.</p>
<p>In operational environments it&apos;s likely science data providers would typically be responsible for providing a Kinesis stream with the appropriate permissions.</p>
<p>For more information on how this process works and how to develop a process that will add records to a stream, read the <a href="https://aws.amazon.com/documentation/kinesis/" target="_blank">Kinesis documentation</a> and the <a href="https://docs.aws.amazon.com/streams/latest/dev/introduction.html" target="_blank">developer guide</a>.</p>
<h4 id="source-data">Source Data</h4>
<p>This entry will run the SyncGranule task against a single target data file.  To that end it will require a single data file to be present in an S3 bucket matching the Provider configured in the next section.</p>
<h4 id="collection-and-provider">Collection and Provider</h4>
<p>Cumulus will need to be configured with a Collection and Provider entry of your choosing.  The provider should match the location of the source data from the <code>Ingest Source Data</code> section.</p>
<p>This can be done via the <a href="https://github.com/nasa/cumulus-dashboard" target="_blank">Cumulus Dashboard</a> if installed or the <a href="../api.md">API</a>.  It is strongly recommended to use the dashboard if possible.</p>
<hr>
<h2 id="configure-the-workflow">Configure the Workflow</h2>
<p>Provided the prerequisites have been fulfilled, you can begin adding the needed values to your Cumulus configuration to configure the example workflow.</p>
<p>The following are steps that are required to set up your Cumulus instance to run the example workflow:</p>
<h4 id="example-cnm-workflow-configuration">Example CNM Workflow Configuration</h4>
<p>In this example, we&apos;re going to trigger a workflow by creating a Kinesis rule and sending a record to a Kinesis stream.</p>
<p>The following <a href="../workflows/">workflow definition</a> should be added to your deployment&apos;s <code>workflows.yml</code>.</p>
<p>Update the <code>CNMResponseStream</code> key in the <code>CnmResponse</code> task to match the name of the Kinesis response stream you configured in the prerequisites section.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">CNMExampleWorkflow:</span>
<span class="hljs-attr">  Comment:</span> CNMExampleWorkflow
<span class="hljs-attr">  StartAt:</span> StartStatus
<span class="hljs-attr">  States:</span>
<span class="hljs-attr">    StartStatus:</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${SfSnsReportLambdaFunction.Arn}
<span class="hljs-attr">      CumulusConfig:</span>
<span class="hljs-attr">        cumulus_message:</span>
<span class="hljs-attr">          input:</span> <span class="hljs-string">&apos;{$}&apos;</span>
<span class="hljs-attr">      Next:</span> TranslateMessage
<span class="hljs-attr">      Catch:</span>
<span class="hljs-attr">        - ErrorEquals:</span>
<span class="hljs-bullet">          -</span> States.ALL
<span class="hljs-attr">          ResultPath:</span> <span class="hljs-string">&apos;$.exception&apos;</span>
<span class="hljs-attr">          Next:</span> CnmResponse
<span class="hljs-attr">    TranslateMessage:</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${CNMToCMALambdaFunction.Arn}
<span class="hljs-attr">      CumulusConfig:</span>
<span class="hljs-attr">        cumulus_message:</span>
<span class="hljs-attr">          outputs:</span>
<span class="hljs-attr">            - source:</span> <span class="hljs-string">&apos;{$.cnm}&apos;</span>
<span class="hljs-attr">              destination:</span> <span class="hljs-string">&apos;{$.meta.cnm}&apos;</span>
<span class="hljs-attr">            - source:</span> <span class="hljs-string">&apos;{$}&apos;</span>
<span class="hljs-attr">              destination:</span> <span class="hljs-string">&apos;{$.payload}&apos;</span>
<span class="hljs-attr">      Catch:</span>
<span class="hljs-attr">        - ErrorEquals:</span>
<span class="hljs-bullet">          -</span> States.ALL
<span class="hljs-attr">          ResultPath:</span> <span class="hljs-string">&apos;$.exception&apos;</span>
<span class="hljs-attr">          Next:</span> CnmResponse
<span class="hljs-attr">      Next:</span> SyncGranule
<span class="hljs-attr">    SyncGranule:</span>
<span class="hljs-attr">      CumulusConfig:</span>
<span class="hljs-attr">        provider:</span> <span class="hljs-string">&apos;{$.meta.provider}&apos;</span>
<span class="hljs-attr">        buckets:</span> <span class="hljs-string">&apos;{$.meta.buckets}&apos;</span>
<span class="hljs-attr">        collection:</span> <span class="hljs-string">&apos;{$.meta.collection}&apos;</span>
<span class="hljs-attr">        downloadBucket:</span> <span class="hljs-string">&apos;{$.meta.buckets.private.name}&apos;</span>
<span class="hljs-attr">        stack:</span> <span class="hljs-string">&apos;{$.meta.stack}&apos;</span>
<span class="hljs-attr">        cumulus_message:</span>
<span class="hljs-attr">          outputs:</span>
<span class="hljs-attr">            - source:</span> <span class="hljs-string">&apos;{$.granules}&apos;</span>
<span class="hljs-attr">              destination:</span> <span class="hljs-string">&apos;{$.meta.input_granules}&apos;</span>
<span class="hljs-attr">            - source:</span> <span class="hljs-string">&apos;{$}&apos;</span>
<span class="hljs-attr">              destination:</span> <span class="hljs-string">&apos;{$.payload}&apos;</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${SyncGranuleLambdaFunction.Arn}
<span class="hljs-attr">      Retry:</span>
<span class="hljs-attr">        - ErrorEquals:</span>
<span class="hljs-bullet">            -</span> States.ALL
<span class="hljs-attr">          IntervalSeconds:</span> <span class="hljs-number">10</span>
<span class="hljs-attr">          MaxAttempts:</span> <span class="hljs-number">3</span>
<span class="hljs-attr">      Catch:</span>
<span class="hljs-attr">        - ErrorEquals:</span>
<span class="hljs-bullet">          -</span> States.ALL
<span class="hljs-attr">          ResultPath:</span> <span class="hljs-string">&apos;$.exception&apos;</span>
<span class="hljs-attr">          Next:</span> CmrResponse
<span class="hljs-attr">      Next:</span> CnmResponse
<span class="hljs-attr">    CnmResponse:</span>
<span class="hljs-attr">      CumulusConfig:</span>
<span class="hljs-attr">        OriginalCNM:</span> <span class="hljs-string">&apos;{$.meta.cnm}&apos;</span>
<span class="hljs-attr">        CNMResponseStream:</span> <span class="hljs-string">&apos;ADD YOUR RESPONSE STREAM HERE&apos;</span>
<span class="hljs-attr">        region:</span> <span class="hljs-string">&apos;us-east-1&apos;</span>
<span class="hljs-attr">        WorkflowException:</span> <span class="hljs-string">&apos;{$.exception}&apos;</span>
<span class="hljs-attr">        cumulus_message:</span>
<span class="hljs-attr">          outputs:</span>
<span class="hljs-attr">            - source:</span> <span class="hljs-string">&apos;{$}&apos;</span>
<span class="hljs-attr">              destination:</span> <span class="hljs-string">&apos;{$.meta.cnmResponse}&apos;</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${CnmResponseLambdaFunction.Arn}
<span class="hljs-attr">      Retry:</span>
<span class="hljs-attr">        - ErrorEquals:</span>
<span class="hljs-bullet">            -</span> States.ALL
<span class="hljs-attr">          IntervalSeconds:</span> <span class="hljs-number">5</span>
<span class="hljs-attr">          MaxAttempts:</span> <span class="hljs-number">3</span>
<span class="hljs-attr">      Catch:</span>
<span class="hljs-attr">        - ErrorEquals:</span>
<span class="hljs-bullet">          -</span> States.ALL
<span class="hljs-attr">          ResultPath:</span> <span class="hljs-string">&apos;$.exception&apos;</span>
<span class="hljs-attr">          Next:</span> StopStatus
<span class="hljs-attr">      Next:</span> StopStatus
<span class="hljs-attr">    StopStatus:</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${SfSnsReportLambdaFunction.Arn}
<span class="hljs-attr">      CumulusConfig:</span>
<span class="hljs-attr">        sfnEnd:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">        stack:</span> <span class="hljs-string">&apos;{$.meta.stack}&apos;</span>
<span class="hljs-attr">        bucket:</span> <span class="hljs-string">&apos;{$.meta.buckets.internal.name}&apos;</span>
<span class="hljs-attr">        stateMachine:</span> <span class="hljs-string">&apos;{$.cumulus_meta.state_machine}&apos;</span>
<span class="hljs-attr">        executionName:</span> <span class="hljs-string">&apos;{$.cumulus_meta.execution_name}&apos;</span>
<span class="hljs-attr">        cumulus_message:</span>
<span class="hljs-attr">          input:</span> <span class="hljs-string">&apos;{$}&apos;</span>
<span class="hljs-attr">      Catch:</span>
<span class="hljs-attr">        - ErrorEquals:</span>
<span class="hljs-bullet">          -</span> States.ALL
<span class="hljs-attr">          Next:</span> WorkflowFailed
<span class="hljs-attr">      End:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">    WorkflowFailed:</span>
<span class="hljs-attr">      Type:</span> Fail
<span class="hljs-attr">      Cause:</span> <span class="hljs-string">&apos;Workflow failed&apos;</span>
</code></pre>
<p>Again, please make sure to modify the value CNMResponseStream to match the stream name (not ARN) for your Kinesis response stream.</p>
<h4 id="task-configuration">Task Configuration</h4>
<p>The following tasks are required to be defined in the <code>lambdas.yml</code> configuration file.</p>
<p>If you&apos;re using a deployment based on the <a href="https://github.com/nasa/cumulus/tree/master/example" target="_blank">example deployment</a> these lambdas should already be defined for you.</p>
<h6 id="cnmtocma">CNMToCMA</h6>
<p>The example workflow assumes you have a CNM to Cumulus Message Adapter (CMA) translation lambda defined as <code>CNMToCMA</code> in the <code>lambdas.yml</code> file:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">CNMToCMA:</span>
<span class="hljs-attr">  handler:</span> <span class="hljs-string">&apos;gov.nasa.cumulus.CnmToGranuleHandler::handleRequestStreams&apos;</span>
<span class="hljs-attr">  timeout:</span> <span class="hljs-number">300</span>
<span class="hljs-attr">  runtime:</span> java8
<span class="hljs-attr">  memory:</span> <span class="hljs-number">128</span>
<span class="hljs-attr">  s3Source:</span>
<span class="hljs-attr">    bucket:</span> <span class="hljs-string">&apos;cumulus-data-shared&apos;</span>
<span class="hljs-attr">    key:</span> <span class="hljs-string">&apos;daacs/podaac/cnmToGranule-1.0-wCMA.zip&apos;</span>
<span class="hljs-attr">  useMessageAdapter:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">  launchInVpc:</span> <span class="hljs-literal">true</span>
</code></pre>
<p><code>CNMToCMA</code> is meant for the beginning of a workflow: it maps CNM granule information to a payload for downstream tasks. This workflow will not utilize the payload. For other workflows, you would need to ensure that downstream tasks in your workflow either understand the CNM message <em>or</em> include a translation task like this one.</p>
<p>You can also manipulate the data sent to downstream tasks using <code>CumulusConfig</code> for various states in <code>workflows.yml</code>. Read more about how to configure data on the <a href="https://nasa.github.io/cumulus/workflows/input_output.html" target="_blank">Workflow Input &amp; Output</a> page.</p>
<h6 id="cnmresponse">CnmResponse</h6>
<p>The workflow defined above assumes a CNM response task defined in the <code>lambdas.yml</code> configuration file. Example:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">CnmResponse:</span>
<span class="hljs-attr">  handler:</span> <span class="hljs-string">&apos;gov.nasa.cumulus.CNMResponse::handleRequestStreams&apos;</span>
<span class="hljs-attr">  timeout:</span> <span class="hljs-number">300</span>
<span class="hljs-attr">  useMessageAdapter:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">  runtime:</span> java8
<span class="hljs-attr">  memory:</span> <span class="hljs-number">256</span>
<span class="hljs-attr">  s3Source:</span>
<span class="hljs-attr">    bucket:</span> <span class="hljs-string">&apos;cumulus-data-shared&apos;</span><span class="hljs-string">&apos;
    key: &apos;</span>daacs/podaac/cnmResponse<span class="hljs-bullet">-1.0</span>.zip<span class="hljs-string">&apos;
  launchInVpc: true
</span></code></pre>
<p>The <code>CnmResponse</code> lambda generates a CNM response message and puts it on a the <code>CNMResponseStream</code> Kinesis stream.</p>
<p>The <code>CnmResponse</code> lambda package is provided (as of release 1.8) in the <code>cumulus-data-shared</code> bucket, with documentation provided in the <a href="https://git.earthdata.nasa.gov/projects/POCUMULUS/repos/cnmresponsetask/browse" target="_blank">source repository</a>.</p>
<p>You can read more about the expected schema a <code>CnmResponse</code> record on the wiki page for <a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cloud+Notification+Mechanism#CloudNotificationMechanism-ResponseMessageFields" target="_blank">Cloud Notification Mechanism</a>.</p>
<h6 id="additional-tasks">Additional Tasks</h6>
<p>Lastly, this entry also includes the tasks  <code>SfSnsReport</code>, <code>SyncGranule</code> from the <a href="https://github.com/nasa/cumulus/tree/master/example" target="_blank">example deployment</a> are defined in the <code>lambdas.yml</code>.</p>
<h3 id="redeploy">Redeploy</h3>
<p>Once the above configuration changes have been made, redeploy your stack.</p>
<p>Please refer to <code>Updating Cumulus deployment</code> in the <a href="../deployment/">deployment documentation</a> if you are unfamiliar with redeployment.</p>
<h3 id="rule-configuration">Rule Configuration</h3>
<p><code>@cumulus/api</code> includes a <code>kinesisConsumer</code> lambda function (<a href="https://github.com/nasa/cumulus/blob/master/packages/api/lambdas/kinesis-consumer.js" target="_blank">kinesis-consumer</a>). Cumulus kinesis-type rules create the <a href="https://docs.aws.amazon.com/lambda/latest/dg/API_CreateEventSourceMapping.html" target="_blank">event source mappings</a> between Kinesis streams and the <code>kinesisConsumer</code> lambda. The <code>kinesisConsumer</code> lambda consumes records from one or more Kinesis streams, as defined by enabled kinesis-type rules. When new records are pushed to one of these streams, the <code>kinesisConsumer</code> triggers workflows associated with the enabled kinesis-type rules.</p>
<p>To add a rule via the dashboard (if you&apos;d like to use the API, see the docs <a href="https://nasa.github.io/cumulus-api/#create-rule" target="_blank">here</a>), navigate to the <code>Rules</code> page and click <code>Add a rule</code>, then configure the new rule using the following template (substituting correct values for parameters denoted by <code>${}</code>:</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;collection&quot;</span>: {
    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;L2_HR_PIXC&quot;</span>,
    <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;000&quot;</span>
  },
  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;L2_HR_PIXC_kinesisRule&quot;</span>,
  <span class="hljs-string">&quot;provider&quot;</span>: <span class="hljs-string">&quot;PODAAC_SWOT&quot;</span>,
  <span class="hljs-string">&quot;rule&quot;</span>: {
    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;kinesis&quot;</span>,
    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;arn:aws:kinesis:{{awsRegion}}:{{awsAccountId}}:stream/{{streamName}}&quot;</span>
  },
  <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;ENABLED&quot;</span>,
  <span class="hljs-string">&quot;workflow&quot;</span>: <span class="hljs-string">&quot;KinesisTriggerTest&quot;</span>
}
</code></pre>
<p><strong>Please Note:</strong></p>
<ul>
<li>The rule&apos;s <code>value</code> attribute value must match the Amazon Resource Name <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" target="_blank">ARN</a> for the Kinesis data stream you&apos;ve preconfigured.   You should be able to obtain this ARN from the Kinesis Dashboard entry for the selected stream.</li>
<li>The collection and provider should match the collection and provider you setup in the <a href="#prerequisites"><code>Prerequisites</code></a> section.</li>
</ul>
<p>Once you&apos;ve clicked on &apos;submit&apos; a new rule should appear in the dashboard&apos;s Rule Overview.</p>
<hr>
<h2 id="execute-the-workflow">Execute the Workflow</h2>
<p>Once Cumulus has been redeployed and a rule has been added, we&apos;re ready to trigger the workflow and watch it execute.</p>
<h3 id="how-to-trigger-the-workflow">How to Trigger the Workflow</h3>
<p>To trigger matching workflows, you will need to put a record on the Kinesis stream the <a href="https://github.com/nasa/cumulus/blob/master/packages/api/lambdas/kinesis-consumer.js" target="_blank">kinesis-consumer</a> lambda will recognize as a matching event. Most importantly, it should include a <code>collection</code> key / value pair that matches a valid collection.</p>
<p>For the purpose of this example, the easiest way to accomplish this is using the <a href="https://aws.amazon.com/cli/" target="_blank">AWS CLI</a>.</p>
<h4 id="create-record-json">Create Record JSON</h4>
<p>Construct a JSON file containing an object that matches the values that have been previously setup. This JSON object should be a valid <a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cloud+Notification+Mechanism" target="_blank">Cloud Notification Mechanism</a> message.</p>
<p><strong>Please note</strong>: <em>this example is somewhat contrived, as the downstream tasks don&apos;t care about most of these fields. A &apos;real&apos; data ingest workflow would.</em></p>
<p>The following values (denoted by ${} in the sample below) should be replaced to match values we&apos;ve previously configured:</p>
<ul>
<li><code>TEST_DATA_FILE_NAME</code>:  The filename of the test data that is available in the S3 (or other) provider we created earlier.</li>
<li><code>TEST_DATA_URI</code>: The full S3 path to the test data (e.g. s3://bucket-name/path/granule)</li>
<li><code>COLLECTION</code>:  The collection defined in the prerequisites for this product</li>
</ul>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;product&quot;</span>: {
    <span class="hljs-string">&quot;files&quot;</span>: [
      {
        <span class="hljs-string">&quot;checksum-type&quot;</span>: <span class="hljs-string">&quot;md5&quot;</span>,
        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;${TEST_DATA_FILE_NAME}&quot;</span>,
        <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;bogus_checksum_value&quot;</span>,
        <span class="hljs-string">&quot;uri&quot;</span>: <span class="hljs-string">&quot;${TEST_DATA_URI}&quot;</span>,
        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;data&quot;</span>,
        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">12345678</span>
      }
    ],
    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;${TEST_DATA_FILE_NAME}&quot;</span>,
    <span class="hljs-string">&quot;dataVersion&quot;</span>: <span class="hljs-string">&quot;006&quot;</span>
  },
  <span class="hljs-string">&quot;identifier &quot;</span>: <span class="hljs-string">&quot;testIdentifier123456&quot;</span>,
  <span class="hljs-string">&quot;collection&quot;</span>: <span class="hljs-string">&quot;${COLLECTION}&quot;</span>,
  <span class="hljs-string">&quot;provider&quot;</span>: <span class="hljs-string">&quot;TestProvider&quot;</span>,
  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;001&quot;</span>
}
</code></pre>
<h4 id="add-record-to-kinesis-data-stream">Add Record to Kinesis Data Stream</h4>
<p>Using the JSON file you created, push it to the Kinesis notification stream:</p>
<pre><code class="lang-bash">aws kinesis put-record --stream-name YOUR_KINESIS_NOTIFICATION_STREAM_NAME_HERE --partition-key 1 --data file:///path/to/file.json
</code></pre>
<p><strong>Please note</strong>: The above command uses the stream name, <em>not</em> the ARN.</p>
<p>The command should return output similar to:</p>
<pre><code class="lang-json">{
    <span class="hljs-string">&quot;ShardId&quot;</span>: <span class="hljs-string">&quot;shardId-000000000000&quot;</span>,
    <span class="hljs-string">&quot;SequenceNumber&quot;</span>: <span class="hljs-string">&quot;42356659532578640215890215117033555573986830588739321858&quot;</span>
}
</code></pre>
<p>This command will put a record containing the JSON from the <code>--data</code> flag onto the Kinesis data stream. The <code>kinesisConsumer</code> lambda will consume the record and construct a valid CMA payload to trigger workflows. For this example, the record will trigger the <code>CNMExampleWorkflow</code> workflow as defined by the rule previously configured.</p>
<p>You can view the current running executions on the <code>Executions</code> dashboard page which presents a list of all executions, their status (running, failed, or completed), to which workflow the execution belongs, along with other information.</p>
<h3 id="verify-workflow-execution">Verify Workflow Execution</h3>
<p>As detailed above, once the record is added to the Kinesis data stream, the <code>kinesisConsumer</code> lambda will trigger the <code>CNMExampleWorkflow</code> .</p>
<h4 id="startstatus">StartStatus</h4>
<p>The first task in the execution will report to Cumulus that the workflow has started execution and pass the CNM message to the next step in the workflow</p>
<h4 id="translatemessage">TranslateMessage</h4>
<p><code>TranslateMessage</code> (which corresponds to the <code>CNMToCMA</code> lambda) will take the CNM object payload and add a granules object to the CMA payload that&apos;s consistent with other Cumulus ingest tasks, and add a key &apos;cnm&apos; to &apos;meta&apos; (as well as the payload) to store the original message.</p>
<p><em>For more on the Message Adapter, please see <a href="../workflows/cumulus-task-message-flow.html">the Message Flow documentation</a></em>.</p>
<p>An example of what is happening in the <code>CNMToCMA</code> lambda is as follows:</p>
<p>Example Input Payload:</p>
<pre><code class="lang-json"><span class="hljs-string">&quot;payload&quot;</span>: {
  <span class="hljs-string">&quot;identifier &quot;</span>: <span class="hljs-string">&quot;testIdentifier123456&quot;</span>,
  <span class="hljs-string">&quot;product&quot;</span>: {
    <span class="hljs-string">&quot;files&quot;</span>: [
      {
        <span class="hljs-string">&quot;checksum-type&quot;</span>: <span class="hljs-string">&quot;md5&quot;</span>,
        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;MOD09GQ.A2016358.h13v04.006.2016360104606.hdf&quot;</span>,
        <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;bogus_checksum_value&quot;</span>,
        <span class="hljs-string">&quot;uri&quot;</span>: <span class="hljs-string">&quot;s3://some_bucket/cumulus-test-data/pdrs/MOD09GQ.A2016358.h13v04.006.2016360104606.hdf&quot;</span>,
        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;data&quot;</span>,
        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">12345678</span>
      }
    ],
    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;TestGranuleUR&quot;</span>,
    <span class="hljs-string">&quot;dataVersion&quot;</span>: <span class="hljs-string">&quot;006&quot;</span>
  },
  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span>,
  <span class="hljs-string">&quot;collection&quot;</span>: <span class="hljs-string">&quot;MOD09GQ&quot;</span>,
  <span class="hljs-string">&quot;provider&quot;</span>: <span class="hljs-string">&quot;TestProvider&quot;</span>
}
</code></pre>
<p>Example Output Payload:</p>
<pre><code class="lang-json">  <span class="hljs-string">&quot;payload&quot;</span>: {
    <span class="hljs-string">&quot;cnm&quot;</span>: {
      <span class="hljs-string">&quot;identifier &quot;</span>: <span class="hljs-string">&quot;testIdentifier123456&quot;</span>,
      <span class="hljs-string">&quot;product&quot;</span>: {
        <span class="hljs-string">&quot;files&quot;</span>: [
          {
            <span class="hljs-string">&quot;checksum-type&quot;</span>: <span class="hljs-string">&quot;md5&quot;</span>,
            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;MOD09GQ.A2016358.h13v04.006.2016360104606.hdf&quot;</span>,
            <span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;bogus_checksum_value&quot;</span>,
            <span class="hljs-string">&quot;uri&quot;</span>: <span class="hljs-string">&quot;s3://some-bucket/cumulus-test-data/data/MOD09GQ.A2016358.h13v04.006.2016360104606.hdf&quot;</span>,
            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;data&quot;</span>,
            <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">12345678</span>
          }
        ],
        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;TestGranuleUR&quot;</span>,
        <span class="hljs-string">&quot;dataVersion&quot;</span>: <span class="hljs-string">&quot;006&quot;</span>
      },
      <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span>,
      <span class="hljs-string">&quot;collection&quot;</span>: <span class="hljs-string">&quot;MOD09GQ&quot;</span>,
      <span class="hljs-string">&quot;provider&quot;</span>: <span class="hljs-string">&quot;TestProvider&quot;</span>
    },
    <span class="hljs-string">&quot;granules&quot;</span>: [
      {
        <span class="hljs-string">&quot;granuleId&quot;</span>: <span class="hljs-string">&quot;TestGranuleUR&quot;</span>,
        <span class="hljs-string">&quot;files&quot;</span>: [
          {
            <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;some-bucket/data&quot;</span>,
            <span class="hljs-string">&quot;url_path&quot;</span>: <span class="hljs-string">&quot;s3://some-bucket/cumulus-test-data/data/MOD09GQ.A2016358.h13v04.006.2016360104606.hdf&quot;</span>,
            <span class="hljs-string">&quot;bucket&quot;</span>: <span class="hljs-string">&quot;some-bucket&quot;</span>,
            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;MOD09GQ.A2016358.h13v04.006.2016360104606.hdf&quot;</span>,
            <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">12345678</span>
          }
        ]
      }
    ]
  }
</code></pre>
<h4 id="syncgranules">SyncGranules</h4>
<p>This lambda will take the files listed in the payload and move them to <code>s3://{deployment-private-bucket}/file-staging/{deployment-name}/{COLLECTION}/{file_name}</code>.</p>
<h4 id="cnmresponse">CnmResponse</h4>
<p>Assuming a successful execution of the workflow, this task will recover the &apos;cnm&apos; key from the &apos;meta&apos; portion of the CMA output, and add a &quot;SUCCESS&quot; record to the notification Kinesis stream.</p>
<p>If a prior step in the the workflow has failed, this will add a &quot;FAILURE&quot; record to the stream instead.</p>
<p>The data written to the <code>CnmResponseStream</code> should adhere to the <a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cloud+Notification+Mechanism#CloudNotificationMechanism-ResponseMessageFields" target="_blank">Response Message Fields</a> schema.</p>
<p><strong>Example CNM Success Response</strong></p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;provider&quot;</span>: <span class="hljs-string">&quot;PODAAC_SWOT&quot;</span>,
  <span class="hljs-string">&quot;collection&quot;</span>: <span class="hljs-string">&quot;SWOT_Prod_l2:1&quot;</span>,
  <span class="hljs-string">&quot;ingestTime&quot;</span>:<span class="hljs-string">&quot;2017-09-30T03:45:29.791198&quot;</span>,
  <span class="hljs-string">&quot;receivedTime&quot;</span>:<span class="hljs-string">&quot;2017-09-30T03:42:31.634552&quot;</span>,
  <span class="hljs-string">&quot;deliveryTime&quot;</span>:<span class="hljs-string">&quot;2017-09-30T03:42:29.791198&quot;</span>,
  <span class="hljs-string">&quot;identifier&quot;</span>: <span class="hljs-string">&quot;1234-abcd-efg0-9876&quot;</span>,
  <span class="hljs-string">&quot;response&quot;</span>: {
    <span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;SUCCESS&quot;</span>
  }
}
</code></pre>
<p><strong>Example CNM Error Response</strong></p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;provider&quot;</span>: <span class="hljs-string">&quot;PODAAC_SWOT&quot;</span>,
  <span class="hljs-string">&quot;collection&quot;</span>: <span class="hljs-string">&quot;SWOT_Prod_l2:1&quot;</span>,
  <span class="hljs-string">&quot;ingestTime&quot;</span>:<span class="hljs-string">&quot;2017-09-30T03:45:29.791198&quot;</span>,
  <span class="hljs-string">&quot;deliveryTime&quot;</span>:<span class="hljs-string">&quot;2017-09-30T03:42:29.791198&quot;</span>,
  <span class="hljs-string">&quot;receivedTime&quot;</span>:<span class="hljs-string">&quot;2017-09-30T03:42:31.634552&quot;</span>,
  <span class="hljs-string">&quot;identifier&quot;</span>: <span class="hljs-string">&quot;1234-abcd-efg0-9876&quot;</span>,
  <span class="hljs-string">&quot;response&quot;</span>: {
    <span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;FAILURE&quot;</span>,
    <span class="hljs-string">&quot;errorCode&quot;</span>: <span class="hljs-string">&quot;INGEST_ERROR&quot;</span>,
    <span class="hljs-string">&quot;errorMessage&quot;</span>: <span class="hljs-string">&quot;File [cumulus-dev-a4d38f59-5e57-590c-a2be-58640db02d91/prod_20170926T11:30:36/production_file.nc] did not match gve checksum value.&quot;</span>
  }
}
</code></pre>
<p>Note the <code>CnmResponse</code> state defined in the <code>workflows.yml</code> above configures <code>$.exception</code> to be passed to the <code>CnmResponse</code> lambda keyed under <code>config.WorkflowException</code>. This is required for the <code>CnmResponse</code> code to deliver a failure response.</p>
<p>To test the failure scenario, send a record missing the <code>collection</code> key.</p>
<h4 id="stopstatus">StopStatus</h4>
<p>In case of either success <em>or</em> failure, <code>CnmResponse</code> will then pass the results to <code>StopStatus</code>. <code>StopStatus</code> will cause the workflow to fail or succeed accordingly.</p>
<hr>
<h2 id="verify-results">Verify results</h2>
<h3 id="check-for-successful-execution-on-the-dashboard">Check for successful execution on the dashboard</h3>
<p>Following the successful execution of this workflow, you should expect to see the workflow complete successfully on the dashboard:</p>
<p><img src="../images/cnm_success_example.png" alt=""></p>
<h3 id="check-the-test-granule-has-been-delivered-to-s3-staging">Check the test granule has been delivered to S3 staging</h3>
<p>The test granule identified in the Kinesis record should be moved to the deployment&apos;s private staging area.</p>
<h3 id="check-for-kinesis-records">Check for Kinesis records</h3>
<p>A <code>SUCCESS</code> notification should be present on the <code>CNMResponseStream</code> Kinesis stream.</p>
<p>You should be able to validate the notification and response streams have the expected records with the following steps (the AWS CLI Kinesis <a href="https://docs.aws.amazon.com/streams/latest/dev/fundamental-stream.html" target="_blank">Basic Stream Operations</a> is useful to review before proceeding):</p>
<ul>
<li>Get a shard iterator (substituting your stream name as appropriate):</li>
</ul>
<pre><code class="lang-bash">aws kinesis get-shard-iterator \
  --shard-id shardId-000000000000 \
  --shard-iterator-type LATEST \
  --stream-name NOTIFICATION_OR_RESPONSE_STREAM_NAME
</code></pre>
<p>which should result in an output to:</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;ShardIterator&quot;</span>: <span class="hljs-string">&quot;VeryLongString==&quot;</span>
}
</code></pre>
<ul>
<li>Re-trigger the workflow by using the <code>put-record</code> command from</li>
<li>As the workflow completes, use the output from the <code>get-shard-iterator</code> command to request data from the stream:</li>
</ul>
<pre><code class="lang-bash">aws kinesis get-records --shard-iterator SHARD_ITERATOR_VALUE
</code></pre>
<p>This should result in output similar to:</p>
<pre><code class="lang-json">{
    <span class="hljs-string">&quot;Records&quot;</span>: [
        {
            <span class="hljs-string">&quot;SequenceNumber&quot;</span>: <span class="hljs-string">&quot;49586720336541656798369548102057798835250389930873978882&quot;</span>,
            <span class="hljs-string">&quot;ApproximateArrivalTimestamp&quot;</span>: <span class="hljs-number">1532664689.128</span>,
            <span class="hljs-string">&quot;Data&quot;</span>: <span class="hljs-string">&quot;eyJpZGVudGlmaWVyICI6InRlc3RJZGVudGlmaWVyMTIzNDU2IiwidmVyc2lvbiI6IjAwNiIsImNvbGxlY3Rpb24iOiJNT0QwOUdRIiwicHJvdmlkZXIiOiJUZXN0UHJvdmlkZXIiLCJwcm9kdWN0U2l6ZSI6MTkwODYzNS4wLCJyZXNwb25zZSI6eyJzdGF0dXMiOiJTVUNDRVNTIn0sInByb2Nlc3NDb21wbGV0ZVRpbWUiOiIyMDE4LTA3LTI3VDA0OjExOjI4LjkxOSJ9&quot;</span>,
            <span class="hljs-string">&quot;PartitionKey&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>
        },
        {
            <span class="hljs-string">&quot;SequenceNumber&quot;</span>: <span class="hljs-string">&quot;49586720336541656798369548102059007761070005796999266306&quot;</span>,
            <span class="hljs-string">&quot;ApproximateArrivalTimestamp&quot;</span>: <span class="hljs-number">1532664707.149</span>,
            <span class="hljs-string">&quot;Data&quot;</span>: <span class="hljs-string">&quot;eyJpZGVudGlmaWVyICI6InRlc3RJZGVudGlmaWVyMTIzNDU2IiwidmVyc2lvbiI6IjAwNiIsImNvbGxlY3Rpb24iOiJNT0QwOUdRIiwicHJvdmlkZXIiOiJUZXN0UHJvdmlkZXIiLCJwcm9kdWN0U2l6ZSI6MTkwODYzNS4wLCJyZXNwb25zZSI6eyJzdGF0dXMiOiJTVUNDRVNTIn0sInByb2Nlc3NDb21wbGV0ZVRpbWUiOiIyMDE4LTA3LTI3VDA0OjExOjQ2Ljk1OCJ9&quot;</span>,
            <span class="hljs-string">&quot;PartitionKey&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>
        }
    ],
    <span class="hljs-string">&quot;NextShardIterator&quot;</span>: <span class="hljs-string">&quot;AAAAAAAAAAFo9SkF8RzVYIEmIsTN+1PYuyRRdlj4Gmy3dBzsLEBxLo4OU+2Xj1AFYr8DVBodtAiXbs3KD7tGkOFsilD9R5tA+5w9SkGJZ+DRRXWWCywh+yDPVE0KtzeI0andAXDh9yTvs7fLfHH6R4MN9Gutb82k3lD8ugFUCeBVo0xwJULVqFZEFh3KXWruo6KOG79cz2EF7vFApx+skanQPveIMz/80V72KQvb6XNmg6WBhdjqAA==&quot;</span>,
    <span class="hljs-string">&quot;MillisBehindLatest&quot;</span>: <span class="hljs-number">0</span>
}
</code></pre>
<p>Note the data encoding is not human readable and would need to be parsed/converted to be interpretable. There are many options to build a Kineis consumer such as the <a href="https://docs.aws.amazon.com/streams/latest/dev/developing-consumers-with-kcl.html" target="_blank">KCL</a>.</p>
<p>For purposes of validating the workflow, it may be simpler to locate the workflow in the <a href="https://console.aws.amazon.com/states/home" target="_blank">Step Function Management Console</a> and assert the expected output is similar to the below examples.</p>
<p><strong>Successful CNM Response Object Example:</strong></p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;cnmResponse&quot;</span>: {
    <span class="hljs-string">&quot;productSize&quot;</span>: <span class="hljs-number">12345678</span>,
    <span class="hljs-string">&quot;processCompleteTime&quot;</span>: <span class="hljs-string">&quot;2018-07-27T05:43:41.698&quot;</span>,
    <span class="hljs-string">&quot;collection&quot;</span>: <span class="hljs-string">&quot;MOD09GQ&quot;</span>,
    <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span>,
    <span class="hljs-string">&quot;provider&quot;</span>: <span class="hljs-string">&quot;TestProvider&quot;</span>,
    <span class="hljs-string">&quot;identifier &quot;</span>: <span class="hljs-string">&quot;testIdentifier123456&quot;</span>,
    <span class="hljs-string">&quot;response&quot;</span>: {
      <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;SUCCESS&quot;</span>
  }
}
</code></pre>
<hr>
<h2 id="kinesis-record-error-handling">Kinesis Record Error Handling</h2>
<p>The default Kinesis stream processing in the Cumulus system is configured for record error tolerance.</p>
<p>When the <code>kinesisConsumer</code> fails to process a record, the failure is captured and the record is published to the <code>kinesisFallback</code> SNS Topic. The <code>kinesisFallback</code> SNS topic broadcasts the record and a subscribed copy of the <code>kinesisConsumer</code> lambda named <code>kinesisFallback</code> consumes these failures.</p>
<p>At this point, the <a href="https://docs.aws.amazon.com/lambda/latest/dg/retries-on-errors.html" target="_blank">normal lambda asynchronous invocation retry behavior</a> will attempt to process the record 3 mores times. After this, if the record cannot successfully be processed, it is written to a <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html" target="_blank">dead letter queue</a>. Cumulus&apos; dead letter queue is an SQS Queue named <code>kinesisFailure</code>. Operators can use this queue to inspect failed records.</p>
<p>This system ensures when <code>kinesisCosumer</code> fails to process a record and trigger a workflow, the record is retried 3 times. This retry behavior improves system reliability in case of any external service failure outside of Cumulus control.</p>
<p>The Kinesis error handling system - the <code>kinesisFallback</code> SNS topic, <code>kinesisConsumer</code> lambda, and <code>kinesisFailure</code> SQS queue - come with the API package and do not need to be configured by the operator.</p>
<p><img src="../images/Kinesis-Error-Processing.png" alt=""></p>
<p>To examine records that were unable to be processed at any step you need to go look at the dead letter queue <code>{{stackname}}-kinesisFailure</code>.
Check the <a href="https://console.aws.amazon.com/sqs/home" target="_blank">Simple Queue Service (SQS) console</a>. Select your queue, and under the <code>Queue Actions</code> tab, you can choose <code>View/Delete Messages</code>. <code>Start polling</code> for messages and you will see records that failed to process through the <code>kinesisConsumer</code>.</p>
<p>Note, these are only records that occurred when processing records from Kinesis streams. Workflow failures are handled differently.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="sips-workflow.html" class="navigation navigation-prev " aria-label="Previous page: SIPS Workflow">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="error-handling.html" class="navigation navigation-next " aria-label="Next page: Error Handling">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"CNM Workflow","level":"2.5","depth":1,"next":{"title":"Error Handling","level":"2.6","depth":1,"path":"data-cookbooks/error-handling.md","ref":"data-cookbooks/error-handling.md","articles":[]},"previous":{"title":"SIPS Workflow","level":"2.4","depth":1,"path":"data-cookbooks/sips-workflow.md","ref":"data-cookbooks/sips-workflow.md","articles":[]},"dir":"ltr"},"config":{"plugins":[],"root":"docs","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Cumulus Documentation","gitbook":"*"},"file":{"path":"data-cookbooks/cnm-workflow.md","mtime":"2018-10-24T21:57:57.453Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-10-24T21:59:10.434Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

