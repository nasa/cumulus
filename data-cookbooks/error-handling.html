
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Error Handling Â· Cumulus Documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="choice-states.html" />
    
    
    <link rel="prev" href="cnm-workflow.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Documentation</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Home
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../architecture.html">
            
                <a href="../architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../workflows/">
            
                <a href="../workflows/">
            
                    
                    What are Cumulus Workflows?
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../workflows/protocol.html">
            
                <a href="../workflows/protocol.html">
            
                    
                    Workflow Protocol
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../tasks.html">
            
                <a href="../tasks.html">
            
                    
                    Workflow Tasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../workflows/input_output.html">
            
                <a href="../workflows/input_output.html">
            
                    
                    Workflow Input & Ouptut
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../workflows/cumulus-task-message-flow.html">
            
                <a href="../workflows/cumulus-task-message-flow.html">
            
                    
                    Workflow Task Message Flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../workflows/developing-workflow-tasks.html">
            
                <a href="../workflows/developing-workflow-tasks.html">
            
                    
                    Developing Workflow Tasks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1" data-path="../workflows/lambda.html">
            
                <a href="../workflows/lambda.html">
            
                    
                    Lambda Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.2" data-path="../workflows/docker.html">
            
                <a href="../workflows/docker.html">
            
                    
                    Dockerization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../workflows/workflow-configuration-how-to.html">
            
                <a href="../workflows/workflow-configuration-how-to.html">
            
                    
                    Workflow Configuration How-to's
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../workflows/workflow-triggers.html">
            
                <a href="../workflows/workflow-triggers.html">
            
                    
                    Workflow Triggers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Deployment
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../deployment/">
            
                <a href="../deployment/">
            
                    
                    How to Deploy Cumulus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../deployment/create_bucket.html">
            
                <a href="../deployment/create_bucket.html">
            
                    
                    Creating an S3 Bucket
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../deployment/iam_roles.html">
            
                <a href="../deployment/iam_roles.html">
            
                    
                    Locating IAMs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../deployment/troubleshoot_deployment.html">
            
                <a href="../deployment/troubleshoot_deployment.html">
            
                    
                    Troubleshooting Deployment
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <a target="_blank" href="https://nasa.github.io/cumulus-api">
            
                    
                    Cumulus API Docs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Additional Cumulus Features
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../data_in_dynamodb.html">
            
                <a href="../data_in_dynamodb.html#cumulus-metadata-in-dynamodb">
            
                    
                    Cumulus Metadata in DynamoDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../data_in_dynamodb.html">
            
                <a href="../data_in_dynamodb.html#backup-and-restore-with-aws">
            
                    
                    DynamoDB Backup and Restore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../data_in_dynamodb.html">
            
                <a href="../data_in_dynamodb.html#dynamodb-auto-scaling">
            
                    
                    DynamoDB Auto Scaling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../ems_reporting.html">
            
                <a href="../ems_reporting.html">
            
                    
                    EMS Reporting
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <a target="_blank" href="https://github.com/nasa/cumulus/blob/master/CHANGELOG.md">
            
                    
                    Changelog
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../upgrade/">
            
                <a href="../upgrade/">
            
                    
                    Upgrade Instructions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../upgrade/1.6.0.html">
            
                <a href="../upgrade/1.6.0.html">
            
                    
                    1.6.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../upgrade/1.7.0.html">
            
                <a href="../upgrade/1.7.0.html">
            
                    
                    1.7.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../upgrade/1.9.0.html">
            
                <a href="../upgrade/1.9.0.html">
            
                    
                    1.9.0
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../system-documentation/system-documentation.html">
            
                <a href="../system-documentation/system-documentation.html">
            
                    
                    Operating and Troubleshooting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../doc_installation.html">
            
                <a href="../doc_installation.html">
            
                    
                    Contributing to documentation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../adding-a-task.html">
            
                <a href="../adding-a-task.html">
            
                    
                    Contributing a task
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../team.html">
            
                <a href="../team.html">
            
                    
                    Team
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Data Cookbook</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="about-cookbooks.html">
            
                <a href="about-cookbooks.html">
            
                    
                    About Cookbooks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="setup.html">
            
                <a href="setup.html">
            
                    
                    Collections, Providers, Schemas, and Rules
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="hello-world.html">
            
                <a href="hello-world.html">
            
                    
                    HelloWorldWorkflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="sns.html">
            
                <a href="sns.html">
            
                    
                    SNS Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="sips-workflow.html">
            
                <a href="sips-workflow.html">
            
                    
                    SIPS Workflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="cnm-workflow.html">
            
                <a href="cnm-workflow.html">
            
                    
                    CNM Workflow
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.6" data-path="error-handling.html">
            
                <a href="error-handling.html">
            
                    
                    Error Handling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="choice-states.html">
            
                <a href="choice-states.html">
            
                    
                    Choice States
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Error Handling</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="error-handling-in-workflows">Error Handling in Workflows</h1>
<p>Cumulus Workflow error handling is configurable via Cumulus Workflow Definitions. These workflow definitions are AWS Step Function definitions, and AWS Step Functions enable users to configure what the state machine does next when an exception is thrown. Read more in the AWS docs: <a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-error-handling.html" target="_blank">How Step Functions Works: Error Handling</a>.</p>
<p>Cumulus Workflow Tasks <em>should</em> throw errors and rely on the state machine logic to handle the error state. Errors and exceptions thrown in Cumulus Workflow Tasks using the Cumulus Message Adapter (CMA) are caught and rethrown by the CMA libraries <em>unless</em> the error name contains <code>WorkflowError</code>.</p>
<p>The former (tasks which throw errors which are not <code>WorkflowError</code>s) is the expected behavior. However a <code>WorklowError</code> can be used to handle errors that should <em>not</em> result in task failure.</p>
<h2 id="workflow-configuration">Workflow Configuration</h2>
<p>Some best practices for error handling in Cumulus Workflows are:</p>
<ul>
<li>Include the <code>sf2snsEndLambdaFunction</code> as a final state (aka the <code>StopStatus</code> state). This broadcasts workflow results to an SNS topic.</li>
<li>States should include a <code>Catch</code> configuration object which defines the <code>ResultPath</code> to be <code>$.exception</code>. This passes along the entire Cumulus Message to the next state with the addition of the <code>Error</code> and <code>Cause</code> details of the thrown error in the <code>exception</code> key.</li>
<li>States may be configured to <code>Retry</code> a task on specified failures to handle transient issues, such as those arising from resource allocation throttling, instead of failing the entire workflow. Cumulus supports the AWS retry configuration outlined <a href="https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-errors.html#amazon-states-language-retrying-after-error" target="_blank">here</a> and an example is provided in the <code>HelloWorld</code> step of the <code>RetryPassWorkflow</code> workflow defined in the Cumulus repository&apos;s <a href="https://github.com/nasa/cumulus/blob/master/example/workflows.yml" target="_blank">example</a> <code>workflow.yml</code>.</li>
<li>Tasks downstream of failed tasks should understand how to pass along exceptions if required: If a task throws an error which is caught by the workflow configuration and passed to another state which also uses the CMA, the CMA overrides the exception key to <code>&quot;None&quot;</code> so the exception will not be passed to downstream tasks after the next state. This is okay if the exception is not needed in downstream tasks. However, <code>sf2snsEndLambdaFunction</code> does need an exception to understand the workflow is in a failed state, so the error should be re-thrown in any states between the original failed task and <code>sf2snsEndLambdaFunction</code>. In the example below, <code>CnmResponseFail</code> re-throws any errors passed by upstream tasks.</li>
<li>If multiple downstream tasks should run after a workflow task has thrown an error, for example sending a failure to a kinesis stream in addition to running the <code>sf2snsEndLambdaFunction</code>, this can handled by creating a second &quot;failure&quot; branch of the workflow.</li>
</ul>
<p><strong>Example:</strong></p>
<p>Note: In the example below, YAML syntax (i.e. <code>&amp;ErrorEqualDefaults</code> and <code>&lt;&lt;: *ErrorEqualDefaults</code>) is used to create references to reusable blocks which makes the definition less repetitive. Read more here: <a href="https://blog.daemonl.com/2016/02/yaml.html" target="_blank">YAML - Anchors, References, Extend</a>.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">KinesisTriggerTest:</span>
<span class="hljs-attr">  Comment:</span> <span class="hljs-string">&apos;Tests Workflow from Kinesis Stream&apos;</span>
<span class="hljs-attr">  StartAt:</span> StartStatus
<span class="hljs-attr">  States:</span>
<span class="hljs-attr">    StartStatus:</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${SfSnsReportLambdaFunction.Arn}
<span class="hljs-attr">      Catch:</span>
<span class="hljs-bullet">        -</span> <span class="hljs-meta">&amp;ErrorEqualDefaults</span>
<span class="hljs-attr">          ErrorEquals:</span>
<span class="hljs-bullet">          -</span> States.ALL
<span class="hljs-attr">          ResultPath:</span> <span class="hljs-string">&apos;$.exception&apos;</span>
<span class="hljs-attr">          Next:</span> CnmResponseFail
<span class="hljs-attr">      Next:</span> TranslateMessage
<span class="hljs-attr">    TranslateMessage:</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${CNMToCMALambdaFunction.Arn}
<span class="hljs-attr">      Catch:</span>
<span class="hljs-bullet">        -</span> &lt;&lt;: <span class="hljs-meta">*ErrorEqualDefaults</span>
<span class="hljs-attr">      Next:</span> SyncGranule
<span class="hljs-attr">    SyncGranule:</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${SyncGranuleLambdaFunction.Arn}
<span class="hljs-attr">      Catch:</span>
<span class="hljs-bullet">        -</span> &lt;&lt;: <span class="hljs-meta">*ErrorEqualDefaults</span>
<span class="hljs-attr">      Next:</span> CnmResponse
<span class="hljs-attr">    CnmResponse:</span> <span class="hljs-meta">&amp;CnmResponseDefaults</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${CnmResponseLambdaFunction.Arn}
<span class="hljs-attr">      Catch:</span>
<span class="hljs-bullet">        -</span> &lt;&lt;: <span class="hljs-meta">*ErrorEqualDefaults</span>
<span class="hljs-attr">          Next:</span> StopStatus
<span class="hljs-attr">      Next:</span> StopStatus
<span class="hljs-attr">    CnmResponseFail:</span>
      &lt;&lt;: <span class="hljs-meta">*CnmResponseDefaults</span>
<span class="hljs-attr">      Catch:</span>
<span class="hljs-bullet">        -</span> &lt;&lt;: <span class="hljs-meta">*ErrorEqualDefaults</span>
<span class="hljs-attr">          Next:</span> StopStatusFail
<span class="hljs-attr">      Next:</span> StopStatusFail
<span class="hljs-attr">    StopStatus:</span> <span class="hljs-meta">&amp;StopStatusDefaults</span>
<span class="hljs-attr">      Type:</span> Task
<span class="hljs-attr">      Resource:</span> ${sf2snsEndLambdaFunction.Arn}
<span class="hljs-attr">      Next:</span> WorkflowSucceeded
<span class="hljs-attr">    StopStatusFail:</span>
      &lt;&lt;: <span class="hljs-meta">*StopStatusDefaults</span>
<span class="hljs-attr">      Catch:</span>
<span class="hljs-attr">        - ErrorEquals:</span>
<span class="hljs-bullet">          -</span> States.ALL
<span class="hljs-attr">          Next:</span> WorkflowFailed
<span class="hljs-attr">      Next:</span> WorkflowFailed
<span class="hljs-attr">    WorkflowSucceeded:</span>
<span class="hljs-attr">      Type:</span> Succeed
<span class="hljs-attr">    WorkflowFailed:</span>
<span class="hljs-attr">      Type:</span> Fail
<span class="hljs-attr">      Cause:</span> <span class="hljs-string">&apos;Workflow failed&apos;</span>
</code></pre>
<p>The above results in a workflow which is visualized in the diagram below:</p>
<p><img src="kinesis-workflow.png" alt="Kinesis Workflow"></p>
<h2 id="summary">Summary</h2>
<p>Error handling should (mostly) be the domain of workflow configuration.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="cnm-workflow.html" class="navigation navigation-prev " aria-label="Previous page: CNM Workflow">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="choice-states.html" class="navigation navigation-next " aria-label="Next page: Choice States">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Error Handling","level":"2.6","depth":1,"next":{"title":"Choice States","level":"2.7","depth":1,"path":"data-cookbooks/choice-states.md","ref":"data-cookbooks/choice-states.md","articles":[]},"previous":{"title":"CNM Workflow","level":"2.5","depth":1,"path":"data-cookbooks/cnm-workflow.md","ref":"data-cookbooks/cnm-workflow.md","articles":[]},"dir":"ltr"},"config":{"plugins":[],"root":"docs","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Cumulus Documentation","gitbook":"*"},"file":{"path":"data-cookbooks/error-handling.md","mtime":"2018-09-04T20:52:58.714Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-09-04T20:54:18.037Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

