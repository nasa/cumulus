{
  "Comment": "Moves granules across collections",
  "StartAt": "EcsTaskMoveGranuleCollections",
  "States": {
    "EcsTaskMoveGranuleCollections": {
      "Parameters": {
        "cma": {
          "event": {
            "payload": {
              "granules": [
                {
                  "status": "completed",
                  "collectionId": "MOD11A1___006",
                  "granuleId": "MOD11A1.A2017200.h19v04.006.2017201090724",
                  "files": [
                    {
                      "key": "move-granule-collection-testing/MOD11A1.A2017200.h19v04.006.2017201090724.hdf",
                      "bucket": "cumulus-test-sandbox-protected",
                      "type": "data",
                      "fileName": "MOD11A1.A2017200.h19v04.006.2017201090724.hdf"
                    },
                    {
                      "key": "move-granule-collection-testing/MOD11A1.A2017200.h19v04.006.2017201090724_1.jpg",
                      "bucket": "cumulus-test-sandbox-private",
                      "type": "browse",
                      "fileName": "MOD11A1.A2017200.h19v04.006.2017201090724_1.jpg"
                    },
                    {
                      "key": "move-granule-collection-testing/MOD11A1.A2017200.h19v04.006.2017201090724_2.jpg",
                      "bucket": "cumulus-test-sandbox-public",
                      "type": "browse",
                      "fileName": "MOD11A1.A2017200.h19v04.006.2017201090724_2.jpg"
                    },
                    {
                      "key": "move-granule-collection-testing/MOD11A1.A2017200.h19v04.006.2017201090724.cmr.xml",
                      "bucket": "cumulus-test-sandbox-protected",
                      "type": "metadata",
                      "fileName": "MOD11A1.A2017200.h19v04.006.2017201090724.cmr.xml"
                    }
                  ]
                }
              ]
            }
          },
          "task_config": {
            "buckets": "{$.meta.buckets}",
            "provider": "{$.meta.provider}",
            "collection": "{$.meta.collection}"
          },
          "meta": {
            "collection": {
              "files": [
                {
                  "regex": "^MOD11A1\\.A[\\d]{7}\\.[\\S]{6}\\.006.[\\d]{13}\\.hdf$",
                  "sampleFileName": "MOD11A1.A2017200.h19v04.006.2017201090724.hdf",
                  "bucket": "protected"
                },
                {
                  "regex": "^BROWSE\\.MOD11A1\\.A[\\d]{7}\\.[\\S]{6}\\.006.[\\d]{13}\\.hdf$",
                  "sampleFileName": "BROWSE.MOD11A1.A2017200.h19v04.006.2017201090724.hdf",
                  "bucket": "private"
                },
                {
                  "regex": "^MOD11A1\\.A[\\d]{7}\\.[\\S]{6}\\.006.[\\d]{13}\\.hdf\\.met$",
                  "sampleFileName": "MOD11A1.A2017200.h19v04.006.2017201090724.hdf.met",
                  "bucket": "private"
                },
                {
                  "regex": "^MOD11A1\\.A[\\d]{7}\\.[\\S]{6}\\.006.[\\d]{13}\\.cmr\\.xml$",
                  "sampleFileName": "MOD11A1.A2017200.h19v04.006.2017201090724.cmr.xml",
                  "bucket": "public"
                },
                {
                  "regex": "^MOD11A1\\.A[\\d]{7}\\.[\\S]{6}\\.006.[\\d]{13}_2\\.jpg$",
                  "sampleFileName": "MOD11A1.A2017200.h19v04.006.2017201090724_2.jpg",
                  "bucket": "public"
                },
                {
                  "regex": "^MOD11A1\\.A[\\d]{7}\\.[\\S]{6}\\.006.[\\d]{13}_1\\.jpg$",
                  "sampleFileName": "MOD11A1.A2017200.h19v04.006.2017201090724_1.jpg",
                  "bucket": "public",
                  "url_path": "move-granule-collection-testing-target/jpg/example2/"
                }
              ],
              "url_path": "move-granule-collection-testing-target",
              "name": "MOD11A2",
              "granuleIdExtraction": "(MOD11A1\\.(.*))\\.hdf",
              "granuleId": "^MOD11A1\\.A[\\d]{7}\\.[\\S]{6}\\.006.[\\d]{13}$",
              "dataType": "MOD11A2",
              "process": "modis",
              "version": "006",
              "sampleFileName": "MOD11A1.A2017200.h19v04.006.2017201090724.hdf",
              "id": "MOD11A2"
            },
            "buckets": {
              "internal": {
                "name": "cumulus-test-sandbox-internal"
              },
              "private": {
                "name": "cumulus-test-sandbox-private",
                "type": "private"
              },
              "protected": {
                "name": "cumulus-test-sandbox-protected",
                "type": "protected"
              },
              "public": {
                "name": "cumulus-test-sandbox-public",
                "type": "public"
              }
            }
          }
        }
      },
      "Type": "Task",
      "Resource": "${ecs_task_move_granule_collections_id}",
      "TimeoutSeconds": 60,
      "Retry": [
        {
          "ErrorEquals": [
            "States.Timeout"
          ],
          "MaxAttempts": 1
        }
      ],
      "End": true
    }
  }
}
